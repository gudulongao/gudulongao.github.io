<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="小磊砸的布劳格">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="小磊砸的布劳格">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小磊砸的布劳格">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>小磊砸的布劳格</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小磊砸的布劳格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/zookeeper-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/19/zookeeper-5/" itemprop="url">zookeeper 设计特点及适用场景</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T22:29:33+08:00">
                2019-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/19/zookeeper-5/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/19/zookeeper-5/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2019/03/19/zookeeper-5/zk1.png" alt="zk集群">  </p>
<p>ZK是一个高吞吐量的分布式协调系统。其自身是一个分布式系统。一个ZK集群由多个Server节点通过数据复制和同步来提供数据的一致性服务。</p>
<p><img src="/2019/03/19/zookeeper-5/read.png" alt="读操作性能图">  </p>
<p>ZK是一个以高吞吐为目标的系统。如上图所示，纵轴是请求数据，横轴是读操作的占比。可以看到对于读多写少的场景具有很好的性能表现。</p>
<h1 id="高吞吐的特点"><a href="#高吞吐的特点" class="headerlink" title="高吞吐的特点"></a>高吞吐的特点</h1><ul>
<li>集群中任何节点都可以响应客户端读请求（<em>只是读请求</em>），并且客户端在任何一个节点看到的视图都是一致的（数据一致性）。zk还支持增加节点来横向拓展（易拓展）。</li>
<li>ZK将所有的数据都存储在内存中，读写操作高效。没有磁盘IO操作。</li>
<li>ZK并不是强一致性，为了高吞吐，不要求数据的实时一致性。允许分布式数据通过时间进行复制同步后达到最终的一致性。</li>
</ul>
<blockquote>
<p><em>对于写请求或者说事务请求，分布式数据需要进行数据的复制同步，节点数越多同步复制的耗时越久，影响系统吞吐量，所以在横向拓展时对于事务请求并不是节点越多越好。</em></p>
</blockquote>
<h1 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h1><ul>
<li>leader：基于leader选举产生的唯一节点，负责整个ZK服务的事务请求和服务调度。</li>
<li>follower：参与leader选举。处理读请求转发事务请求到leader。参与事务请求Proposal的投票</li>
<li>observer：弱化的follower，只是处理读请求以及转发事务请求到leader，不参leader选举和Proposal投票。设计这个角色只是在不影响集群事务处理能力的前提下提升集群的非事务处理的吞吐量。</li>
</ul>
<h1 id="事务请求过程"><a href="#事务请求过程" class="headerlink" title="事务请求过程"></a>事务请求过程</h1><ul>
<li>事务请求都先转发到leader。leader会将事务请求转换成Proposal协议。并为协议生成id(Zxid)即全局唯一的事务id。leader按照事务id来对事务请求进行排序和处理的。</li>
<li>leader将Proposal协议放到每个follower对应的任务队列中（leader会为每个follower创建一个队列）。</li>
<li>follower按照FIFO的方式获取任务队列中的Proposal协议。然后以事务日志的方式写入本地磁盘。成功后返回给leader一个ACK响应即Proposal投票。</li>
<li>leader只要收到过半数（follower数）的ACK响应，就会广播一个commit消息给follower通知Proposal协议可以提交。同时leader自身也会提交。</li>
</ul>
<p><img src="/2019/03/19/zookeeper-5/commit.png" alt="事务性操作事绪图">  </p>
<h1 id="leader选举"><a href="#leader选举" class="headerlink" title="leader选举"></a>leader选举</h1><p>ZK进行leader选举只会在一下两个场景：</p>
<ul>
<li>服务刚启动，还没有leader。</li>
<li>leader节点挂了。退出了zk服务。</li>
</ul>
<p>当需要进行leader选举时，每个follower会广播选票，选票包含follower服务id（serverid）以及事务id(Zxid，个人感觉这里说的事务id应该是在服务启动时，每个节点在zk中注册的节点编号)。整个过程如下：</p>
<ul>
<li>每个follower进行第一次投票，广播自己的serverid和Zxid。</li>
<li>follower会收到其他follower的投票，follower会将收到的投票于自己的投票进行比较，找Zxid最大的，如果Zxid一样就找serverid最大的。从而生成新的投票，继续投票。</li>
<li>经过若干轮的投票，某一个follower获得超过半数的投票就会成为新的leader。</li>
</ul>
<blockquote>
<p><em>ZK在leader选举中有偏向，偏向事务id更大的，或者服务id更大的，即数据更新的机器</em></p>
</blockquote>
<p><img src="/2019/03/19/zookeeper-5/serverid.png" alt="serverid">  </p>
<h1 id="故障容错"><a href="#故障容错" class="headerlink" title="故障容错"></a>故障容错</h1><ul>
<li>事务日志：服务器在更新内存数据之前先将事务性操作以日志的形式写入磁盘。follower和leader都会记录事务日志。</li>
<li>数据快照：周期性的将内存中的数据存储成内存快照。</li>
</ul>
<blockquote>
<p><em>很有可能在数据快照后进行了事务性操作，导致数据发生了变化，所以最好的故障恢复是在通过数据快照将数据加载到内存中以后，再通过事务日志来执行操作恢复到最新的数据</em></p>
</blockquote>
<h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><h2 id="命名服务"><a href="#命名服务" class="headerlink" title="命名服务"></a>命名服务</h2><p>ZK的命名服务主要提供两个功能：</p>
<ul>
<li>服务的注册：服务提供方在启动后将提供的服务的地址等信息存储在zk指定的目录节点中，服务消费者则可以从指定的目录节点中获取想要的服务信息。<em>dubbo</em> 个人感觉也可以做服务的注册和服务的发现检查。</li>
<li>全局顺序的id生成器：通过创建顺序的持久节点，将节点编号作为生成的id.<a href="https://blog.csdn.net/xundh/article/details/80167727" target="_blank" rel="noopener">https://blog.csdn.net/xundh/article/details/80167727</a></li>
</ul>
<p><img src="/2019/03/19/zookeeper-5/id.png" alt="id生成器">  </p>
<h2 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h2><p>分布式的产品涉及到的配置都比较的分散，当有变动会牵扯到多台机器的修改。越多的机器部署配置的修改就会变得越困难。将所有的配置全部存储到数据库中可以集中的维护配置，但只能做到启动时读取配置做不到实时的配置更新。<br>可以利用ZK的watch机制。将产品的配置都存储在ZK中的某一个目录节点，并对这个节点做监听，一旦配置发生了变化，应用服务就能够收到通知，优点热部署的感觉。</p>
<p><img src="/2019/03/19/zookeeper-5/configuration.png" alt="配置管理">  </p>
<h2 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h2><p>集群管理就是对集群监控和集群控制。在日常开发和运维过程中，集群管理都想要知道一下几点：</p>
<ul>
<li>实际运行的机器数量。</li>
<li>集群中机器的实时状态。</li>
<li>集群中机器的上线/下线进行控制。</li>
</ul>
<p>主要利用zk临时节点的特性，当有新的机器添加到集群中，就在特定的zk目录节点下新增临时节点，客户端对特定的目录做监听，发现有子节点变化时，感知到有新的节点，这个时候做上线控制。机器会将自己的实时运行状态写入到对应的临时节点中，客户端监听临时节点的数据变化，获取机器的实时状态数据，当机器挂掉退出会话时，其创建的临时节点会被zk删除，客户端感知到特定目录的子节点变化，知道有节点删除，就可以做下线控制。具体可以看<a href="https://blog.csdn.net/en_joker/article/details/78802106" target="_blank" rel="noopener">https://blog.csdn.net/en_joker/article/details/78802106</a> 的例子，讲解的很清晰，感觉zk做集群管理很炸天。</p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>实现分布式锁主要是通过zk的临时顺序节点。<br>在zk目录节点中指定一个目录/lock。当客户端想要加锁时，会在/lock目录下创建临时顺序节点，创建成功后，客户端会获取/lock下的所有子节点，同时判断自己创建的临时节点顺序编号是不是最小的，如果是，则成功获取锁。如果不是，则对比自己创建的临时节点编号小的节点做删除监听，一直阻塞等到监听触发。这样没有获取到锁的客户端都等待比自己先创建的临时节点上，这样形成了关于这个锁的等待队列。只有当最先请求的临时节点被删除（获取锁的客户端完成任务手动删除临时节点，要么获取锁的客户端奔溃退出会话zk自动删除临时节点）才会激活下一个请求锁的客户端。保证了锁的顺序性（无饥饿）。</p>
<p><img src="/2019/03/19/zookeeper-5/lock.png" alt="分布式锁">  </p>
<h2 id="队列管理"><a href="#队列管理" class="headerlink" title="队列管理"></a>队列管理</h2><ul>
<li>同步队列：当队列中元素都齐整了队列才可以被使用。生产者在zk指定目录节点下创建节点，消费者对指定目录的子节点做监听，当子节点个数符合要求时再进行业务处理。</li>
<li>FIFO队列：生产者在zk指定目录节点下创建永久有序的节点，消费者对指定目录子节点做监听，有新的子节点时就可以工作，工作时先消费编号最小的节点并删除。如果队列为空则等待监听触发。</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8629775.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8629775.html</a><br>zookeeper特征总结：<a href="https://www.cnblogs.com/takumicx/p/9508706.html" target="_blank" rel="noopener">https://www.cnblogs.com/takumicx/p/9508706.html</a><br>配置管理：<a href="https://my.oschina.net/OHC1U9jZt/blog/1524613" target="_blank" rel="noopener">https://my.oschina.net/OHC1U9jZt/blog/1524613</a><br>命名服务：<a href="https://www.cnblogs.com/haoxiaozi/p/6318842.html" target="_blank" rel="noopener">https://www.cnblogs.com/haoxiaozi/p/6318842.html</a><br>集群管理：<a href="https://blog.csdn.net/en_joker/article/details/78802106" target="_blank" rel="noopener">https://blog.csdn.net/en_joker/article/details/78802106</a><br>分布式锁：<a href="https://blog.csdn.net/kongmin_123/article/details/82081953" target="_blank" rel="noopener">https://blog.csdn.net/kongmin_123/article/details/82081953</a><br>分布式锁实现：<a href="https://www.cnblogs.com/liuyang0/p/6800538.html" target="_blank" rel="noopener">https://www.cnblogs.com/liuyang0/p/6800538.html</a><br>按照observer模式部署节点：<a href="https://blog.csdn.net/qianshangding0708/article/details/50160891" target="_blank" rel="noopener">https://blog.csdn.net/qianshangding0708/article/details/50160891</a><br>特点总结：<a href="https://www.cnblogs.com/raphael5200/p/5285583.html" target="_blank" rel="noopener">https://www.cnblogs.com/raphael5200/p/5285583.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/17/zookeeper-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/17/zookeeper-4/" itemprop="url">zookeeper api操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-17T10:44:38+08:00">
                2019-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/17/zookeeper-4/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/17/zookeeper-4/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.4.6&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h1 id="样例代码"><a href="#样例代码" class="headerlink" title="样例代码"></a>样例代码</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">package demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import org.apache.zookeeper.*;</span><br><span class="line">import org.apache.zookeeper.data.Stat;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class ZookeeperDemo &#123;</span><br><span class="line">    public static final String ADDRESS = &quot;127.0.0.1:2182&quot;;</span><br><span class="line"></span><br><span class="line">    public static final int SESSION_TIMEOUT = 500;</span><br><span class="line"></span><br><span class="line">    private static void log(String mess) &#123;</span><br><span class="line">        System.out.println(System.currentTimeMillis() + &quot; &quot; + Thread.currentThread().getName() + &quot; &quot; + mess);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取状态信息</span><br><span class="line">     *</span><br><span class="line">     * @param state</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private static String getState(Stat state) &#123;</span><br><span class="line">        StringBuilder builder = new StringBuilder();</span><br><span class="line">        builder.append(&quot;Czxid: &quot; + state.getCzxid()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;Ctime: &quot; + new Date(state.getCtime())).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;Mzxid: &quot; + state.getMzxid()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;Mtime: &quot; + new Date(state.getMtime())).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;Pzxid: &quot; + state.getPzxid()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;version: &quot; + state.getVersion()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;cversion: &quot; + state.getCversion()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;aversion: &quot; + state.getAversion()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;ephemeralOwner: &quot; + state.getEphemeralOwner()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;dataLength: &quot; + state.getDataLength()).append(&quot;\n&quot;);</span><br><span class="line">        builder.append(&quot;numhildren: &quot; + state.getNumChildren()).append(&quot;\n&quot;);</span><br><span class="line">        return builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 基本操作</span><br><span class="line">     */</span><br><span class="line">    public static void testBaseAPI() &#123;</span><br><span class="line">        ZooKeeper client = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //创建连接</span><br><span class="line">            client = new ZooKeeper(ADDRESS, SESSION_TIMEOUT, null);</span><br><span class="line">            //查询根目录下的节点</span><br><span class="line">            List&lt;String&gt; children = client.getChildren(&quot;/&quot;, null);</span><br><span class="line">            log(&quot;children: &quot; + children);</span><br><span class="line"></span><br><span class="line">            client.create(&quot;/test&quot;, &quot;test&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">            //获取节点/test的数据</span><br><span class="line">            byte[] data = client.getData(&quot;/test&quot;, null, null);</span><br><span class="line">            log(&quot;data: &quot; + new String(data));</span><br><span class="line">            //获取节点/test的状态数据</span><br><span class="line">            Stat state = client.exists(&quot;/test&quot;, null);</span><br><span class="line">            log(&quot;stat: &quot; + getState(state));</span><br><span class="line"></span><br><span class="line">            //更新节点/test的数据，需要基于版本号来更新（乐观锁），如果版本号=-1 则强制更新</span><br><span class="line">            state = client.setData(&quot;/test&quot;, &quot;tl1&quot;.getBytes(), state.getVersion());</span><br><span class="line">            log(&quot;stat: &quot; + getState(state));</span><br><span class="line">            data = client.getData(&quot;/test&quot;, null, null);</span><br><span class="line">            log(&quot;stat: &quot; + getState(state));</span><br><span class="line"></span><br><span class="line">            state = client.setData(&quot;/test&quot;, &quot;tl3&quot;.getBytes(), -1);</span><br><span class="line">            log(&quot;stat: &quot; + getState(state));</span><br><span class="line">            data = client.getData(&quot;/test&quot;, null, null);</span><br><span class="line">            log(&quot;stat: &quot; + getState(state));</span><br><span class="line"></span><br><span class="line">            //创建节点</span><br><span class="line">            String result = client.create(&quot;/test/child&quot;, &quot;child&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode</span><br><span class="line">                    .PERSISTENT);</span><br><span class="line"></span><br><span class="line">            client.delete(&quot;/test/child&quot;, -1);</span><br><span class="line">            client.delete(&quot;/test&quot;, -1);</span><br><span class="line">            log(&quot;result: &quot; + result);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (client != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    client.close();</span><br><span class="line">                &#125; catch (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void testWathcer() &#123;</span><br><span class="line">        ZooKeeper client = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //创建连接（带监听）</span><br><span class="line">            client = new ZooKeeper(ADDRESS, SESSION_TIMEOUT, null);</span><br><span class="line">            client.create(&quot;/test&quot;, &quot;test&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">            //通过getData操作添加监听</span><br><span class="line">            //getData的监听只能通过delete和setData触发</span><br><span class="line">            //同时这个监听只能触发一次。如果有两次delete/setData 第二次的操作就不会触发。</span><br><span class="line">            byte[] data = client.getData(&quot;/test&quot;, new Watcher() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void process(WatchedEvent watchedEvent) &#123;</span><br><span class="line">                    log(&quot; path:&quot; + watchedEvent.getPath() + &quot; type: &quot; + watchedEvent.getType());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, null);</span><br><span class="line">            log(&quot;data: &quot; + new String(data));</span><br><span class="line"></span><br><span class="line">            log(&quot;delete...&quot;);</span><br><span class="line">            client.delete(&quot;/test&quot;, -1);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (client != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    client.close();</span><br><span class="line">                &#125; catch (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void testDeleteClose() &#123;</span><br><span class="line">        ZooKeeper client = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            //创建连接</span><br><span class="line">            client = new ZooKeeper(ADDRESS, SESSION_TIMEOUT, null);</span><br><span class="line">            //创建节点</span><br><span class="line">            client.create(&quot;/test&quot;, &quot;test&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">            //获取节点状态信息</span><br><span class="line">            Stat stat = client.exists(&quot;/test&quot;, null);</span><br><span class="line">            //对节点添加监听</span><br><span class="line">            client.getData(&quot;/test&quot;, new Watcher() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void process(WatchedEvent watchedEvent) &#123;</span><br><span class="line">                    log(&quot; path: &quot; + watchedEvent.getPath() + &quot; event: &quot; + watchedEvent.getType());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, stat);</span><br><span class="line"></span><br><span class="line">            //删除节点</span><br><span class="line">            log(&quot;delete...&quot;);</span><br><span class="line">            client.delete(&quot;/test&quot;, -1);</span><br><span class="line"></span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (client != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    client.close();</span><br><span class="line">                &#125; catch (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">//        testBaseAPI();</span><br><span class="line">//        testDeleteClose();</span><br><span class="line">        testWathcer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h1><p><img src="/2019/03/17/zookeeper-4/firetrigger.png" alt="Znode属性">  </p>
<p>zookeeper中的监听只能触发一次。即当我们通过exists、getData和getChildren方法添加的监听只能被触发一次。<br>如果设计成永久的监听，当服务端能够触发监听的操作频繁执行时，客户端也会随之频繁的收到更新的通知。而实际上客户端只是关注于最新的数据，节点状态而并不关心服务端频繁的每次更新。同时当注册的监听客户端很多的场景下会对zookeeper的性能造成额外的负担。</p>
<h2 id="永久监听"><a href="#永久监听" class="headerlink" title="永久监听"></a>永久监听</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">package demo;</span><br><span class="line"></span><br><span class="line">import org.apache.zookeeper.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class MyWatcher implements Watcher &#123;</span><br><span class="line">    private ZooKeeper zk;</span><br><span class="line"></span><br><span class="line">    public MyWatcher(ZooKeeper zk) &#123;</span><br><span class="line">        this.zk = zk;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void process(WatchedEvent watchedEvent) &#123;</span><br><span class="line">        String path = watchedEvent.getPath();</span><br><span class="line">        Event.EventType type = watchedEvent.getType();</span><br><span class="line">        log(&quot; path:&quot; + path + &quot; type:&quot; + type);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            if (Event.EventType.NodeDeleted != type) &#123;</span><br><span class="line">                //再次添加监听（exists操作会对所有的操作都触发）</span><br><span class="line">                zk.exists(path, this);</span><br><span class="line">                zk.getChildren(path, this);</span><br><span class="line">                zk.getData(path, this, null);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; catch (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void log(String mess) &#123;</span><br><span class="line">        System.out.println(System.currentTimeMillis() + &quot; &quot; + Thread.currentThread().getName() + &quot; &quot; + mess);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException, KeeperException, InterruptedException &#123;</span><br><span class="line">        ZooKeeper zk = new ZooKeeper(&quot;127.0.0.1:2182&quot;, 2000, null);</span><br><span class="line">        log(&quot;create node...&quot;);</span><br><span class="line">        zk.create(&quot;/test&quot;, &quot;test&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        log(&quot; add listener...&quot;);</span><br><span class="line">        zk.exists(&quot;/test&quot;, new MyWatcher(zk));</span><br><span class="line">        log(&quot;update data...&quot;);</span><br><span class="line">        zk.setData(&quot;/test&quot;, &quot;abc&quot;.getBytes(), -1);</span><br><span class="line">        log(&quot;update data...&quot;);</span><br><span class="line">        zk.setData(&quot;/test&quot;, &quot;def&quot;.getBytes(), -1);</span><br><span class="line">        log(&quot;add child...&quot;);</span><br><span class="line">        zk.create(&quot;/test/child&quot;, &quot;tl&quot;.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        log(&quot;delete child...&quot;);</span><br><span class="line">        zk.delete(&quot;/test/child&quot;, -1);</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        log(&quot;delete node...&quot;);</span><br><span class="line">        zk.delete(&quot;/test&quot;, -1);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">//        zk.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8623844.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8623844.html</a><br>zookeeper java操作：<a href="https://www.cnblogs.com/LiZhiW/p/4923693.html" target="_blank" rel="noopener">https://www.cnblogs.com/LiZhiW/p/4923693.html</a><br>zookeeper与Eureka的区别：<a href="https://blog.csdn.net/eson_15/article/details/85561179" target="_blank" rel="noopener">https://blog.csdn.net/eson_15/article/details/85561179</a><br>zookeeper为什么设计成永久监听：<a href="https://blog.csdn.net/hongshun0651140/article/details/49705547" target="_blank" rel="noopener">https://blog.csdn.net/hongshun0651140/article/details/49705547</a><br>zookeeper如何永久监听：<a href="https://blog.csdn.net/lemonlhy/article/details/79660408" target="_blank" rel="noopener">https://blog.csdn.net/lemonlhy/article/details/79660408</a>    </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/12/zookeeper-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/12/zookeeper-3/" itemprop="url">zookeeper shell操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T22:31:08+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/12/zookeeper-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/12/zookeeper-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h1><p>以zookeeper/bin目录为基准目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 本机服务</span><br><span class="line">./zkCli.sh</span><br></pre></td></tr></table></figure>
<p><img src="/2019/03/12/zookeeper-3/connect.png" alt="客户端连接">  </p>
<h1 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"># 查看根节点</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] ls /</span><br><span class="line">[zookeeper, testroot]</span><br><span class="line"></span><br><span class="line"># 创建节点（默认是不带编号，永久节点）</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] create /test testcreate</span><br><span class="line">Created /test</span><br><span class="line"></span><br><span class="line"># 查看test节点</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] get /test</span><br><span class="line">testcreate</span><br><span class="line">cZxid = 0x500000002</span><br><span class="line">ctime = Tue Mar 12 22:45:27 CST 2019</span><br><span class="line">mZxid = 0x500000002</span><br><span class="line">mtime = Tue Mar 12 22:45:27 CST 2019</span><br><span class="line">pZxid = 0x500000002</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 10</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"># 创建带编号的永久节点(-s)</span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] create -s /b createwithno</span><br><span class="line">Created /b0000000002</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] get /b</span><br><span class="line">Node does not exist: /b</span><br><span class="line"></span><br><span class="line"># 查看根节点下的节点（发现带节点的不叫b了，而是b和编号）</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] ls /</span><br><span class="line">[b0000000002, zookeeper, test, testroot]</span><br><span class="line"></span><br><span class="line"># 采用正确的名字查看刚刚创建的节点</span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] get /b0000000002</span><br><span class="line">createwithno</span><br><span class="line">cZxid = 0x500000003</span><br><span class="line">ctime = Tue Mar 12 22:48:46 CST 2019</span><br><span class="line">mZxid = 0x500000003</span><br><span class="line">mtime = Tue Mar 12 22:48:46 CST 2019</span><br><span class="line">pZxid = 0x500000003</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 12</span><br><span class="line">numChildren = 0</span><br><span class="line"> </span><br><span class="line"># 创建临时节点(-e)</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] create -e /c createenode </span><br><span class="line">Created /c</span><br><span class="line"></span><br><span class="line"># 查看根节点</span><br><span class="line">[zk: localhost:2181(CONNECTED) 16] ls /</span><br><span class="line">[b0000000002, c, zookeeper, test, testroot]</span><br><span class="line"></span><br><span class="line"># 查看刚刚创建的临时节点信息</span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] get /c</span><br><span class="line">createenode</span><br><span class="line">cZxid = 0x500000004</span><br><span class="line">ctime = Tue Mar 12 22:53:10 CST 2019</span><br><span class="line">mZxid = 0x500000004</span><br><span class="line">mtime = Tue Mar 12 22:53:10 CST 2019</span><br><span class="line">pZxid = 0x500000004</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x169611f66540000</span><br><span class="line">dataLength = 11</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"># 关闭连接后再次连接，查看根节点,发现上一次会话创建的临时节点已删除</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[b0000000002, zookeeper, test, testroot]</span><br><span class="line"></span><br><span class="line"># 删除节点 /testroot </span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] delete /testroot</span><br><span class="line"># 查看根下的节点，发现已删除</span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] ls /</span><br><span class="line">[b0000000002, zookeeper, test]</span><br><span class="line"></span><br><span class="line"># 查看节点的状态</span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] stat /test</span><br><span class="line">cZxid = 0x500000002</span><br><span class="line">ctime = Tue Mar 12 22:45:27 CST 2019</span><br><span class="line">mZxid = 0x500000002</span><br><span class="line">mtime = Tue Mar 12 22:45:27 CST 2019</span><br><span class="line">pZxid = 0x500000002</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 10</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"># 关闭连接</span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] close</span><br><span class="line">2019-03-17 10:25:11,894 [myid:] - INFO  [main:ZooKeeper@684] - Session: 0x1698704f21f0000 closed</span><br><span class="line">[zk: localhost:2181(CLOSED) 9] 2019-03-17 10:25:11,896 [myid:] - INFO  [main-EventThread:ClientCnxn$EventThread@519] - EventThread shut down for session: 0x1698704f21f0000</span><br><span class="line"># 关闭连接之后，会话也就关闭了，这个时候操作提示没有连接</span><br><span class="line">[zk: localhost:2181(CLOSED) 9] ls /</span><br><span class="line">Not connected</span><br><span class="line"></span><br><span class="line"># 退出</span><br><span class="line">[zk: localhost:2181(CLOSED) 10] quit</span><br><span class="line">Quitting..</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8619276.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8619276.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/27/zookeeper-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/27/zookeeper-2/" itemprop="url">ZooKeeper基础介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-27T19:08:53+08:00">
                2019-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/27/zookeeper-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/27/zookeeper-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><p><img src="/2019/02/27/zookeeper-2/system.png" alt="分布式系统架构图">  </p>
<p>如上图所示，分布式系统是由多台机器各自运行的子服务（进程）并通过网络互联来提供一个整体服务的系统。这个整体的服务对于用户而言是无感的。  </p>
<h2 id="分布式系统协调技术"><a href="#分布式系统协调技术" class="headerlink" title="分布式系统协调技术"></a>分布式系统协调技术</h2><blockquote>
<p>在这个分布式系统中如何对进程进行调度，我假设在第一台机器上挂载了一个资源，然后这三个物理分布的进程都要竞争这个资源，但我们又不希望他们同时进行访问，这时候我们就需要一个协调器，来让他们有序的来访问这个资源。这个协调器就是我们经常提到的那个锁，比如说”进程-1”在使用该资源的时候，会先去获得锁，”进程1”获得锁以后会对该资源保持独占，这样其他进程就无法访问该资源，”进程1”用完该资源以后就将锁释放掉，让其他进程来获得锁，那么通过这个锁机制，我们就能保证了分布式系统中多个进程能够有序的访问该临界资源。那么我们把这个分布式环境下的这个锁叫作<strong>分布式锁</strong>。  </p>
</blockquote>
<p><img src="/2019/02/27/zookeeper-2/product.png" alt="分布式锁产品">  </p>
<p>目前主流的分布式锁产品由Google的Chubby(非开源)和Apache的Zookeeper（开源）</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Zookeeper 为了能够对分布式系统进行协调管理，设计了一种数据结构–Znode。Zookeeper节点本身可以看成是一个Znode树。其拥有和文件系统类似的命名空间。</p>
<p><img src="/2019/02/27/zookeeper-2/namespace.png" alt="命名空间">  </p>
<h2 id="Znode"><a href="#Znode" class="headerlink" title="Znode"></a>Znode</h2><p>每个Znode都有自己的路径，这个路径又Uncode字符组成，具有唯一性。并且必须是<strong>绝对路径（以/开始）</strong>。<br>Znode由state,data,children三部分组成。具体如下表所示。</p>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><table>
<thead>
<tr>
<th>部分</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>state</td>
<td>版本，权限(ACL)，时间戳等信息</td>
</tr>
<tr>
<td>data</td>
<td>存储的数据（<strong>最多1M</strong>）</td>
</tr>
<tr>
<td>children</td>
<td>子节点</td>
</tr>
</tbody>
</table>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p><strong>Znode中的数据操作都是具有原子性的，读写都是涉及的节点中的所有数据。Znode都有自己的ACL(访问控制列表)</strong></p>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>Znode有临时节点和永久节点两种类型。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>临时节点</td>
<td>依赖于会话，每个临时节点都会绑定其依赖的sessionid。会话失效就会被自动删除，也可以手工删除，<strong>不能有子节点</strong></td>
</tr>
<tr>
<td>永久节点</td>
<td>不依赖于会话，只有手工删除才会被删除</td>
</tr>
</tbody>
</table>
<h3 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h3><p>Zxid是Zookeeper所使用的一种时间戳。每一次对Znode的操作都会产生一个全局唯一的Zxid，<strong>可以根据Zxid的大小来判断事件发生的时间顺序。</strong><br>整个Znode的属性如下表所示：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>cZxid</strong></td>
<td><strong>创建的事务id</strong></td>
</tr>
<tr>
<td>ctime</td>
<td>创建时间</td>
</tr>
<tr>
<td><strong>mZxid</strong></td>
<td><strong>修改事务id</strong></td>
</tr>
<tr>
<td>mtime</td>
<td>修改时间</td>
</tr>
<tr>
<td><strong>pZxid</strong></td>
<td><strong>创建/删除的事务id</strong></td>
</tr>
<tr>
<td>version</td>
<td>当前节点版本号</td>
</tr>
<tr>
<td>cversion</td>
<td>子节点版本号</td>
</tr>
<tr>
<td>aversion</td>
<td>当前节点的acl版本号</td>
</tr>
<tr>
<td>ephemeralOwner</td>
<td>如果节点是临时节点，则其存储绑定的sessionid，否则为空</td>
</tr>
<tr>
<td>dataLength</td>
<td>数据长度</td>
</tr>
<tr>
<td>numhildren</td>
<td>子节点个数</td>
</tr>
</tbody>
</table>
<p><img src="/2019/02/27/zookeeper-2/znodeprop.png" alt="Znode属性">  </p>
<p>每个Znode都维护着三个Zxid（cZxid,mZxid,pZxid）。<br>Zxid是一个64位的数字，其高32位的epoch是当前leader节点编号，每当leader有变化时，高32位的epoch会随之发生变化。低32是递增计数器。</p>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><p>客户端可以进行的操作如下表所示：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>创建节点（父节点必须存在）</td>
</tr>
<tr>
<td>delete</td>
<td>删除节点（不能包含子节点）</td>
</tr>
<tr>
<td>exists</td>
<td>测试节点是否存在，并获取节点元数据</td>
</tr>
<tr>
<td>getACL/setACL</td>
<td>获取/设置 节点的ACL</td>
</tr>
<tr>
<td>getChildren</td>
<td>获取子节点列表</td>
</tr>
<tr>
<td>getData/setData</td>
<td>获取/更新 节点数据</td>
</tr>
<tr>
<td>sync</td>
<td>客户端视图与服务端同步</td>
</tr>
</tbody>
</table>
<p><strong>对于Znode的更新操作是非阻塞的</strong>  </p>
<p>在命令行中客户端连接可以进行操作可以通过help指令查看。</p>
<p><img src="/2019/02/27/zookeeper-2/help.png" alt="Znode属性">  </p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p>客户端可以在Znode上设置watch，当Znode状态发生变化时（增，删，改）会出发对应的watch。这个时候会像客户端发送有且只有一条通知。<br><strong>观察者（订阅发布）模式</strong></p>
<p>watch有如下特点：</p>
<table>
<thead>
<tr>
<th>特征</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>one-time-trigger</td>
<td>当设置watch的节点状态发生变化时，服务端会发送事件到客户端，如果节点再一次发生状态变化，除非客户端已重新设置了新的watch，否则不会再发送事件</td>
</tr>
<tr>
<td>Send to client</td>
<td>服务端与客户端之间是基于Socket通信的，客户端只有在接受到事件之后才能够感知到节点的状态变化，而由于网络的不确定性。客户端们会在不同的时刻感知某一监听（duo），但Zookeeper的全局唯一的Zxid能够保证事件的顺序。</td>
</tr>
<tr>
<td>The data for which the watch was set</td>
<td>Zookeeper维护了两条监听链，一条数据监听链(data watches)和一条孩子监听链(child watches)。节点不同的操作会触发不同的监听</td>
</tr>
</tbody>
</table>
<h3 id="设置watch"><a href="#设置watch" class="headerlink" title="设置watch"></a>设置watch</h3><p>Zookeeper支持通过所有的读操作（exists,getData和getChildren）来为Znode设置watch。可以理解为在调用api来读取某个Znode的时候可以添加一个监听，这个监听实际是一种回调逻辑。当改节点发生特定的变化时会触发监听从而执行相应的回调逻辑。<br>Znode支持两种watch：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>data watches</td>
<td>exists和getData操作可以设置该watch</td>
</tr>
<tr>
<td>child watches</td>
<td>getChilden操作可以设置该watch</td>
</tr>
</tbody>
</table>
<h3 id="触发watch"><a href="#触发watch" class="headerlink" title="触发watch"></a>触发watch</h3><p><img src="/2019/02/27/zookeeper-2/firetrigger.png" alt="Znode属性">  </p>
<p>通过exits操作设置的watch,监听的Znode创建，删除，修改时会触发。<br>通过getData操作设置的watch，监听的Znode在删除，修改时会触发。<br>通过getChildren操作设置的watch,监听在Znode创建子节点，删除节点，删除子节点是触发。<br>可以看到，删除操作会触发exists,getData和getChildren设置的所有监听。</p>
<h2 id="监听原理"><a href="#监听原理" class="headerlink" title="监听原理"></a>监听原理</h2><p><img src="/2019/02/27/zookeeper-2/watch.png" alt="Znode属性">  </p>
<ul>
<li>ZooKeeper ：部署在远程主机上的 ZooKeeper 集群，当然，也可能是单机的。 </li>
<li>Client ：分布在各处的 ZooKeeper 的 jar 包程序，被引用在各个独立应用程序中。 </li>
<li>WatchManager ：一个接口，用于管理各个监听器，只有一个方法 materialize()，返回一个 Watcher 的 set。</li>
</ul>
<p>在具体流程上，简单讲，客户端在向 ZooKeeper 服务器注册 Watcher 的同时，会将 Watcher 对象存储在客户端的 WatchManager 中。当ZooKeeper 服务器触发 Watcher 事件后，会向客户端发送通知，客户端线程从 WatchManager 的实现类中取出对应的 Watcher 对象来执行回调逻辑。</p>
<h2 id="单点故障解决方案"><a href="#单点故障解决方案" class="headerlink" title="单点故障解决方案"></a>单点故障解决方案</h2><p>对于单点故障，Zookeeper可以基于leader选举策略方便的解决。</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p><img src="/2019/02/27/zookeeper-2/1.png" alt="Znode启动">  </p>
<p>zookeeper启动后，主节点A和主节点B都会在zookeeper注册节点，这个时候，基于leader选举策略，编号小的优先成为master,另一个节点自动阻塞成为一个备用节点。</p>
<h3 id="Master故障"><a href="#Master故障" class="headerlink" title="Master故障"></a>Master故障</h3><p><img src="/2019/02/27/zookeeper-2/2.png" alt="Znode故障">  </p>
<p>当主节点A出现故障，zookeeper后自动感知节点的状态，将自动删除故障节点，然后再次选举，这个时候主节点B获胜，成为新的master节点。</p>
<h3 id="Master恢复"><a href="#Master恢复" class="headerlink" title="Master恢复"></a>Master恢复</h3><p><img src="/2019/02/27/zookeeper-2/3.png" alt="Znode故障">  </p>
<p>当主节点A恢复后，会再次在zookeeper注册一个新的节点，编号会继续增加。Zookeeper感知到节点变化会再次进行选举，这个时候主节点B的编号还是最小的，主节点B再次获胜，成为master节点。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8618965.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8618965.html</a><br>zookeeper学习博客：<a href="http://www.cnblogs.com/sunddenly/p/4033574.html" target="_blank" rel="noopener">http://www.cnblogs.com/sunddenly/p/4033574.html</a><br>Zxid高32位epoch：<a href="https://blog.csdn.net/Dongguabai/article/details/82957620" target="_blank" rel="noopener">https://blog.csdn.net/Dongguabai/article/details/82957620</a><br>watch机制：<a href="https://blog.csdn.net/z69183787/article/details/53023578" target="_blank" rel="noopener">https://blog.csdn.net/z69183787/article/details/53023578</a><br>watch原理：<a href="https://blog.csdn.net/hohoo1990/article/details/78617336" target="_blank" rel="noopener">https://blog.csdn.net/hohoo1990/article/details/78617336</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/block/" itemprop="url">同步锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T23:21:44+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/锁/" itemprop="url" rel="index">
                    <span itemprop="name">锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/16/block/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/16/block/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="同步锁"><a href="#同步锁" class="headerlink" title="同步锁"></a>同步锁</h1><table>
<thead>
<tr>
<th>修饰区域</th>
<th>说明</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>修饰对象</td>
<td>对对象加锁</td>
<td><strong>对象锁</strong></td>
</tr>
<tr>
<td>修饰实例方法</td>
<td>对当前实例加锁</td>
<td><strong>this锁</strong></td>
</tr>
<tr>
<td>修饰静态方法</td>
<td>对当前类加锁</td>
<td><strong>类锁</strong></td>
</tr>
<tr>
<td>修饰类</td>
<td>对当前类加锁</td>
<td><strong>类锁</strong></td>
</tr>
</tbody>
</table>
<h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了了解synchronized的实现原理，需要事先对jvm对象的结构，moniter对象的结构有所了解。</p>
<h3 id="对象结构"><a href="#对象结构" class="headerlink" title="对象结构"></a>对象结构</h3><p><img src="/2019/02/16/block/object.png" alt="block"></p>
<p>jvm 中的对象主要由<strong>对象头、实例变量和对齐填充</strong>三个部分组成。</p>
<table>
<thead>
<tr>
<th>部分</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>对象头</td>
<td>对象主要存储对象运行时的数据(<strong>MarkWord</strong>)和元数据(<strong>KlassPointer</strong>)</td>
</tr>
<tr>
<td>实例变量</td>
<td>对象数据数据的存储区域</td>
</tr>
<tr>
<td>对齐填充</td>
<td>为了满足对象的大小是8字节的整数倍，进行填充大小的区域</td>
</tr>
</tbody>
</table>
<h4 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h4><p>其中对象头需要着重了解。<br>对象头由标记字段(<strong>MarkWord</strong>)和元数据指针(<strong>KlassPointer</strong>)两个部分组成。</p>
<table>
<thead>
<tr>
<th>区域</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MarkWord</strong></td>
<td>当前对象的运行时数据，如哈希值，gc标志，锁标记等</td>
</tr>
<tr>
<td><strong>KlassPoniter</strong></td>
<td>指向当前对象所属的类元数据的指针</td>
</tr>
</tbody>
</table>
<p>MarkWord最后2位表明了当前对象的状态。不同的状态存储了不同的内容，如下表所示。</p>
<table>
<thead>
<tr>
<th>标识位</th>
<th>状态</th>
<th>存储内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>01</td>
<td>未锁定，可偏向</td>
<td>对象哈希值、对象分代年龄，偏向线程id，偏向时间戳</td>
</tr>
<tr>
<td>00</td>
<td>轻量级锁</td>
<td>指向LockRecord</td>
</tr>
<tr>
<td>10</td>
<td>重量锁</td>
<td>指向重量级锁</td>
</tr>
<tr>
<td>11</td>
<td>gc标志</td>
<td>空</td>
</tr>
</tbody>
</table>
<p><img src="/2019/02/16/block/markword.png" alt="block">  </p>
<p><strong>MarkWorkd中记录了monitor对象的地址。即每一个对象都拥有一个与之对应的monitor对象。</strong></p>
<h3 id="monitor对象"><a href="#monitor对象" class="headerlink" title="monitor对象"></a>monitor对象</h3><p>monitor对象的结构如下图所示。</p>
<p><img src="/2019/02/16/block/monitor-struct.png" alt="block"></p>
<p>结构说明如下图所示。</p>
<table>
<thead>
<tr>
<th>部分</th>
<th>说明</th>
<th>特征</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>count</strong></td>
<td>记录获取锁的线程数</td>
<td></td>
</tr>
<tr>
<td><strong>ContentionList</strong></td>
<td>所有竞争锁的线程都会进入到这个队列</td>
<td>多个</td>
</tr>
<tr>
<td><strong>EntryList</strong></td>
<td>从ContentionList中随机选择部分线程作为候选线程进入EntryList队列</td>
<td>多个</td>
</tr>
<tr>
<td><strong>Owner</strong></td>
<td>拥有当前锁的线程</td>
<td>一个</td>
</tr>
<tr>
<td><strong>OnDeck</strong></td>
<td>等待获取锁的线程，即候选线程</td>
<td>一个</td>
</tr>
<tr>
<td><strong>WaitSet</strong></td>
<td>等待当前对象的线程队列，调用当前对象的wait方法后，线程会进入当前对象的waitset队列</td>
<td>多个</td>
</tr>
</tbody>
</table>
<p><strong>contentionlist、entrylist、waitset队列中的线程都是阻塞状态</strong>。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="/2019/02/16/block/monitor.png" alt="block"></p>
<p>1、所有想要竞争锁的线程都会先进入到contentionlist队列中。<br>2、从contentionlist中将部分线程作为候选线程转移到entrylist队列中。<br>3、从entrylist队列中随机选择一个线程作为候选线程，OnDeck指向候选线程。如果锁没有被占用，count=0，则候选线程成功获取锁。这个时候owner指向拥有锁的线程，count+1。如果锁已被占用候选线程会等到锁被释放后才会拥有锁。<br>4、当拥有锁的线程再次请求加锁时（<strong>可重入</strong>），monitor对象会判断owner是否时指向当前线程，如果是，则属于重入的场景，只需要count+1即可。<br>5、如果拥有锁的线程释放锁，则count-1。（<strong>重入的线程重入几次就需要释放几次，count也会依次-1</strong>）</p>
<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="阻塞的代价"><a href="#阻塞的代价" class="headerlink" title="阻塞的代价"></a>阻塞的代价</h2><p>java的线程是映射到操作系统原生线程之上的，如果要阻塞或唤醒一个线程就需要操作系统介入，需要在用户态与核心态之间切换，这种切换会消耗大量的系统资源，因为用户态与内核态都有各自专用的内存空间，专用的寄存器等，用户态切换至内核态需要传递给许多变量、参数给内核，内核也需要保护好用户态在切换时的一些寄存器值、变量等，以便内核态调用结束后切换回用户态继续工作。  </p>
<blockquote>
<p>1、如果线程状态切换是一个高频操作时，这将会消耗很多CPU处理时间。<br>2、如果对于那些需要同步的简单的代码块，获取锁挂起操作消耗的时间比用户代码执行的时间还要长，这种同步策略显然非常糟糕的。  </p>
</blockquote>
<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><p>当对象锁发生竞争时，如果owner线程能够在很短的时间释放锁，则竞争线程可以稍微的等一等（自旋，空循环），当owner线程释放锁后，自旋线程会立即获得锁。如果owner线程在超出了自旋阀值后还没有释放锁，则自旋线程停止自旋，进入阻塞状态。<strong>竞争不到锁会先自旋，实在不行才阻塞，尽量降低阻塞的可能性</strong>。  </p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>尽可能的降低锁进入阻塞状态的可能性。减少了内核态和用户态的切换，降低了线程切换造成的系统资源消耗。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p><strong>非公平</strong> 自旋锁在自旋后，如果锁被释放，会立即获取锁资源，相当于抢占了OnDeck(ReadThread)的资源。<br><strong>降低吞吐量</strong> 当占有锁执行的任务时间很长，或者锁的竞争很激烈的场景。锁短时间不会释放，而线程又因为自旋要白白消耗CPU时间片，别的线程又不能立即获得时间片。这无疑会降低系统的吞吐量。<strong>高并发并且线程任务耗时的这种场景建议都关闭自选锁</strong>   </p>
<p><img src="/2019/02/16/block/history.png" alt="block"></p>
<h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><p>偏向锁住要是提升无竞争场景下的加锁/解锁效率。<br>对于加锁/解锁，总会涉及到CAS操作。而<strong>频繁的CAS操作会导致总线风暴从而导致本地延迟。偏向锁的意义在于尽可能的减少CAS操作</strong>。因此偏向锁的想法是一旦线程第一次获得了监视对象，之后让监视对象“偏向”这个线程，之后的多次调用则可以避免CAS操作。<br><strong>偏向锁，偏向第一次拥有锁的线程，后续的运行过程中，如果没有别的竞争线程，则加锁/解锁不会有CAS操作。一旦有别的竞争线程，持有偏向锁的线程会被挂起，jvm会清楚线程的偏向锁，将偏向锁升级为轻量级锁。</strong></p>
<h3 id="偏向锁的获取"><a href="#偏向锁的获取" class="headerlink" title="偏向锁的获取"></a>偏向锁的获取</h3><blockquote>
<p>1、对象锁的MarkWord偏向锁标志=1，锁标志=01，表明当前锁对象是可偏向的。<br>2、判断MarkWord的偏向锁id是否是当前线程，如果是，则直接进入同步代码块。不是，则通过CAS操作在MarkWord中存储当前线程id。<br>3、如果CAS操作成功，则直接进入同步代码块，如果失败，则表明有竞争，拥有偏向锁的线程会挂起，偏向锁会升级为轻量锁，阻塞的线程会竞争轻量锁，竞争成功的线程进入同步代码块。</p>
</blockquote>
<p><img src="/2019/02/16/block/biasedlock.png" alt="block"></p>
<h3 id="偏向锁的释放"><a href="#偏向锁的释放" class="headerlink" title="偏向锁的释放"></a>偏向锁的释放</h3><p>如上图所示，偏向锁遇到有竞争时，拥有偏向锁的线程会挂起，同时会撤销偏向锁。偏向锁的撤销，还会导致stop the world操作，导致性能下降。<br><strong>偏向锁适合无锁竞争的场景下使用</strong>。</p>
<h2 id="轻量锁"><a href="#轻量锁" class="headerlink" title="轻量锁"></a>轻量锁</h2><p>轻量级锁是由偏向锁升级而来的。偏向锁是只有一个线程加锁的情况，当有第二个线程要竞争锁，偏向锁会升级为轻量级锁。</p>
<h3 id="轻量级锁的获取"><a href="#轻量级锁的获取" class="headerlink" title="轻量级锁的获取"></a>轻量级锁的获取</h3><p><img src="/2019/02/16/block/biasedlock2lightlock.png" alt="block"></p>
<blockquote>
<p>1、每一个线程在竞争锁的时候，首先会检查MarkWord中记录的threadid是否是当前线程<strong>(MarkWord锁标志=01)</strong>。如果是，则属于偏向锁，不需要进行锁的申请等操作，直接进入同步代码块。<br>2、如果MarkWord中的threadid不是当前线程。则说明当前存在竞争。这个时候，<strong>通过CAS操作</strong>，根据MarkWord中存储的threadid，通知拥有偏向锁的线程释放偏向锁，清空MarkWord信息，并挂起。同时将偏向锁升级为轻量级锁<strong>(MarkWord锁标志=00)</strong>。<br>3、两个竞争的线程都会在栈帧中创建LockRecord空间。<strong>通过CAS操作</strong>，将共享对象的MarkWord拷贝到LockRecord（官方称之为Displaced Mark Word），同时将对象锁的MarkWord指向LockRecord。CAS操作成功的线程竞争到轻量级锁，可以继续进入同步代码块。CAS操作失败的线程进行自旋。<br>4、自旋线程，自旋后如果成功获取锁（即之前拥有轻量级锁的线程释放了锁）这个时候，自旋线程继续保持轻量级锁进入同步代码块。自旋后如果没有获取锁（即之前拥有轻量级锁的线程还未执行完毕，没有释放锁），之前拥有轻量级锁的线程会挂起，轻量级锁会膨胀为重量级锁<strong>（MarkWord锁=10）</strong>。这个时候所有竞争线程会竞争重量级锁。</p>
</blockquote>
<h3 id="轻量级锁的释放"><a href="#轻量级锁的释放" class="headerlink" title="轻量级锁的释放"></a>轻量级锁的释放</h3><h2 id="重量锁"><a href="#重量锁" class="headerlink" title="重量锁"></a>重量锁</h2><p><img src="/2019/02/16/block/lightlock2wightlock.png" alt="block"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>锁：<a href="http://www.cnblogs.com/charlesblc/p/5994162.html" target="_blank" rel="noopener">http://www.cnblogs.com/charlesblc/p/5994162.html</a><br>对象头：<a href="https://blog.csdn.net/zhoufanyang_china/article/details/54601311" target="_blank" rel="noopener">https://blog.csdn.net/zhoufanyang_china/article/details/54601311</a><br>同步锁：<a href="https://www.cnblogs.com/mingyao123/p/7424911.html" target="_blank" rel="noopener">https://www.cnblogs.com/mingyao123/p/7424911.html</a><br>偏向锁/轻量级锁/重量锁：<a href="https://blog.csdn.net/zqz_zqz/article/details/70233767" target="_blank" rel="noopener">https://blog.csdn.net/zqz_zqz/article/details/70233767</a><br>加锁/释放锁的过程：<a href="https://blog.csdn.net/luo532046043/article/details/82883598" target="_blank" rel="noopener">https://blog.csdn.net/luo532046043/article/details/82883598</a><br>CAS操作导致总线风暴（CAS及SMP架构）：<a href="https://blog.csdn.net/chen77716/article/details/6618779" target="_blank" rel="noopener">https://blog.csdn.net/chen77716/article/details/6618779</a>   </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/15/thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/15/thread/" itemprop="url">线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-15T23:21:44+08:00">
                2019-02-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/高并发/" itemprop="url" rel="index">
                    <span itemprop="name">高并发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/15/thread/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/15/thread/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>线程的状态： <a href="https://www.jianshu.com/p/f65ea68a4a7f" target="_blank" rel="noopener">https://www.jianshu.com/p/f65ea68a4a7f</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/26/zookeeper-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/26/zookeeper-1/" itemprop="url">ZooKeeper安装部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-26T23:19:53+08:00">
                2018-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/26/zookeeper-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/26/zookeeper-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>下载地址：<a href="https://archive.apache.org/dist/zookeeper/" target="_blank" rel="noopener">https://archive.apache.org/dist/zookeeper/</a>  </p>
</blockquote>
<h2 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf zookeeper.tar</span><br></pre></td></tr></table></figure>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><p>将zookeeper压缩包解压之后，conf目录下有样例配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line"># 心跳检测时间（单位毫秒）</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line"># 主从同步时间周期（周期单位为心跳检测的时间）</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line"># 主从交互时等待的时间周期（周期单位为心跳检测时间）</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line"># 数据目录</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk</span><br><span class="line"># 日志目录</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line"># 端口</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br></pre></td></tr></table></figure>
<p>主要的参数如下表所示：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tickTime</td>
<td>心跳检测时间，毫秒级，zookeeper所有的时间都是七整数倍</td>
</tr>
<tr>
<td>initLimit</td>
<td>在leader选举之后，follower与leader同步需要的时间，当leader数据很多时，这个值需要相应的调整</td>
</tr>
<tr>
<td>syncLimit</td>
<td>表示follower,leader与obsrver交互的最大时间，在与leader同步完成之后，正常转发请求的时间</td>
</tr>
<tr>
<td>dataDir</td>
<td>内存数据快照存储地址</td>
</tr>
<tr>
<td>dataLogDir</td>
<td>事务日志存储地址</td>
</tr>
<tr>
<td>clientPort</td>
<td>zookeeper监听客户端连接的端口</td>
</tr>
</tbody>
</table>
<h2 id="操作指令"><a href="#操作指令" class="headerlink" title="操作指令"></a>操作指令</h2><p>zookeeper的相关操作都是基于bin目录下的shell脚本来执行的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 启动服务（默认加载conf目录下的zoo.cfg）</span><br><span class="line">zkServer.sh start </span><br><span class="line"># 查看服务状态</span><br><span class="line">zkServer.sh status</span><br><span class="line"># 停止服务</span><br><span class="line">zkServer.sh stop</span><br><span class="line"># 客户端连接</span><br><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>
<h2 id="单机伪集群部署"><a href="#单机伪集群部署" class="headerlink" title="单机伪集群部署"></a>单机伪集群部署</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><strong>zookeeper集群配置最小需要3个节点</strong>。单机伪集群部署是在同一台机器上通过启动三个zookeeper进程来实现集群效果，需要保证三个zookeeper进程端口不能冲突，相应目录也要隔离开。故在conf目录创建zk1.cfg，zk2.cfg和zk3.cfg三 个配置文件。<br>zk1.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk1</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk1</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>zk2.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk2</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk2</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2182</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>zk3.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk3</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk3</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2183</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>集群配置与单例配置唯一的区别是配置文件中增加了集群中节点的配置。</p>
<p><img src="/2018/11/26/zookeeper-1/groupsetting.png" alt="集群配置">  </p>
<p>简单介绍一下配置的含义：<strong>server.[节点id]=[ip]:[心跳通信端口]:[选举同学端口]</strong>  </p>
<p>这三个配置文件的clientPort端口，dataDir和dataLogDir目录都各自不相同，保证三个zookeeper进程能够顺利启动。<br>接下来需要在三个配置文件的dataDir中创建myid文件，文件内容是节点id。<br>在zookeeper根目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 1&gt; dataDir/zk1/myid</span><br><span class="line">echo 2&gt; dataDir/zk2/myid</span><br><span class="line">echo 3&gt; dataDir/zk3/myid</span><br></pre></td></tr></table></figure>
<h3 id="启停检测"><a href="#启停检测" class="headerlink" title="启停检测"></a>启停检测</h3><p>在bin目录下，以节点1为例，其他节点类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动节点1</span><br><span class="line">zkServer.sh start ../conf/zk1.cfg </span><br><span class="line"># 检测节点1</span><br><span class="line">zkServer.sh status ../conf/zk1.cfg</span><br><span class="line"># 停止节点1</span><br><span class="line">zkServer.sh stop ../conf/zk1.cfg</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p><a href="https://www.cnblogs.com/leocook/p/zk_1.html" target="_blank" rel="noopener">https://www.cnblogs.com/leocook/p/zk_1.html</a><br>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8618965.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8618965.html</a><br>zookeeper安装：<a href="https://www.jianshu.com/p/5491d16e6abd" target="_blank" rel="noopener">https://www.jianshu.com/p/5491d16e6abd</a><br>zookeeper伪集群：<a href="https://www.cnblogs.com/crazylqy/p/7119030.html" target="_blank" rel="noopener">https://www.cnblogs.com/crazylqy/p/7119030.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/14/redblacktree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/14/redblacktree/" itemprop="url">红黑树</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-14T23:02:25+08:00">
                2018-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/14/redblacktree/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/14/redblacktree/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h1><p>二叉搜索树，能够提供较好的查找，插入以及删除的效率。但是当插入的数据都是有序的，这会导致整个二叉搜索树退化为链表。当查找数据的时候由原来的二分查找变成了循环遍历。这种效率降低是因为树不够平衡导致的。红黑树就是对所有的节点增加红黑两种颜色，同时节点直接保持一种颜色的准则，在插入，删除等操作的同时也要维持这个准则，这样红黑树能够在处理排序数据时也能保证树的平衡，能够提供较好的查找效率。</p>
<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><ul>
<li>所有节点要么是红色，要么是黑色</li>
<li>根节点必须是黑色</li>
<li>所有叶子节点的路径中不能有连续的红色节点（红色节点的子节点必须是黑色，反之不一定）</li>
<li>所有叶子节点的路径中黑色个数相同（黑色高度一致）</li>
</ul>
<h1 id="左旋"><a href="#左旋" class="headerlink" title="左旋"></a>左旋</h1><p><img src="/2018/11/14/redblacktree/leftretato.png" alt="左旋"></p>
<p>如图所示。左旋会将当前节点的右节点作为后继节点，当前节点作为后继节点的左子树。</p>
<p><img src="/2018/11/14/redblacktree/redblacktree-1.png" alt="红黑树-1"></p>
<h1 id="右旋"><a href="#右旋" class="headerlink" title="右旋"></a>右旋</h1><p><img src="/2018/11/14/redblacktree/rightretato.png" alt="右旋"></p>
<p>如图所示，右旋会将当亲节点的左子节点为后继节点，当前节点作为后继节点的右子树。</p>
<p><img src="/2018/11/14/redblacktree/redblacktree-2.png" alt="红黑树-2"></p>
<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><p>插入节点逻辑比较复杂。因为要保证插入新节点后整个红黑树还能够保持红黑树的定义。<br>我们默认新插入的节点都是红色的，因为新节点是红色的代价最小。当节点是黑色是一定会使得黑色高度发生变化。而当新节点是红色，当父节点是黑色，则不违背定义，但如果父节点是红色，我们可以通过很小的代价来修正。</p>
<h2 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h2><p>当插入的新节点（红色）后，可能会违背红黑树的定义，这个时候需要进行修正。</p>
<h3 id="父节点为黑色"><a href="#父节点为黑色" class="headerlink" title="父节点为黑色"></a>父节点为黑色</h3><p><img src="/2018/11/14/redblacktree/insert-1.png" alt="插入-1"></p>
<p>这种场景不需要做修正。并不违反红黑树的定义。</p>
<h3 id="父节点为红色，叔叔节点为红色"><a href="#父节点为红色，叔叔节点为红色" class="headerlink" title="父节点为红色，叔叔节点为红色"></a>父节点为红色，叔叔节点为红色</h3><p><img src="/2018/11/14/redblacktree/insert-2.png" alt="插入-2"></p>
<p>这种场景只需要将父节点，叔叔节点都变成黑色，将祖父节点变为红色，再以祖父节点为基准开始修正（递归）。</p>
<h3 id="父节点为红色，叔叔节点为黑色"><a href="#父节点为红色，叔叔节点为黑色" class="headerlink" title="父节点为红色，叔叔节点为黑色"></a>父节点为红色，叔叔节点为黑色</h3><p>当父节点为红色，叔叔节点为黑色时，需要按如下四种场景来进行修正。</p>
<h4 id="父节点是左子节点，新节点为左子节点"><a href="#父节点是左子节点，新节点为左子节点" class="headerlink" title="父节点是左子节点，新节点为左子节点"></a>父节点是左子节点，新节点为左子节点</h4><p><img src="/2018/11/14/redblacktree/insert-3.png" alt="插入-3"></p>
<p>这种场景，需要先将父节点变为黑色，将祖父节点变为红色。再以祖父节点为基准进行右旋。</p>
<h4 id="父节点是右子节点，新节点是右子节点"><a href="#父节点是右子节点，新节点是右子节点" class="headerlink" title="父节点是右子节点，新节点是右子节点"></a>父节点是右子节点，新节点是右子节点</h4><p><img src="/2018/11/14/redblacktree/insert-4.png" alt="插入-4"></p>
<p>这种场景，需要先将父节点变为黑色，将祖父节点变为红色，再以祖父节点为基准进行左旋。</p>
<h4 id="父节点是左子节点，新节点是右子节点"><a href="#父节点是左子节点，新节点是右子节点" class="headerlink" title="父节点是左子节点，新节点是右子节点"></a>父节点是左子节点，新节点是右子节点</h4><p><img src="/2018/11/14/redblacktree/insert-5.png" alt="插入-5"></p>
<p>这种场景，需要先以父节点为基准进行左旋。这个时候整个树会变成父节点时左子节点，新节点也是左子节点的场景，只是新节点是父节点的父节点。<br>这个时候同理，将新节点变为黑色，将祖父节点变为红色，再以祖父节点为基准节点进行右旋。</p>
<h4 id="父节点是右子节点，新节点是左子节点"><a href="#父节点是右子节点，新节点是左子节点" class="headerlink" title="父节点是右子节点，新节点是左子节点"></a>父节点是右子节点，新节点是左子节点</h4><p><img src="/2018/11/14/redblacktree/insert-6.png" alt="插入-6"></p>
<p>这种场景，需要先以父节点为基准进行右旋。这个时候整个树就会变成父节点是右子节点，新节点也是右子节点的场景。只是新节点是父节点的父节点。<br>这个时候同理，将新节点变为黑色，将祖父节点变为红色，再以祖父节点为基准节点进行左旋。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 新增后修正</span><br><span class="line">    *</span><br><span class="line">    * @param currNode 当前节点</span><br><span class="line">    */</span><br><span class="line">   private void insertFix(RedBlackNode&lt;T&gt; currNode) throws Exception &#123;</span><br><span class="line">       NodeType currNodeType = currNode.nodeType();</span><br><span class="line">       //获取父级节点</span><br><span class="line">       RedBlackNode&lt;T&gt; parent = currNode.getParent();</span><br><span class="line">       if (parent == null) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //获取祖父节点</span><br><span class="line">       RedBlackNode&lt;T&gt; grandPa = parent.getParent();</span><br><span class="line">       if (grandPa == null) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //父节点的颜色</span><br><span class="line">       ColourType parentColour = parent.getColour();</span><br><span class="line">       //父节点是黑色不做处理</span><br><span class="line">       if (ColourType.BLACK == parentColour) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //获取父级节点的节点类型</span><br><span class="line">       NodeType parentNodeType = parent.nodeType();</span><br><span class="line">       //获取叔叔节点</span><br><span class="line">       RedBlackNode&lt;T&gt; uncale = getUncaleNode(currNode);</span><br><span class="line">       ColourType uncaleColour = uncale == null ? null : uncale.getColour();</span><br><span class="line">       //父节点是红色，叔叔节点是红色,直接变更父节点与叔叔节点的颜色，修改祖父节点的颜色</span><br><span class="line">       if (ColourType.RED == uncaleColour) &#123;</span><br><span class="line">           parent.setColour(ColourType.BLACK);</span><br><span class="line">           uncale.setColour(ColourType.BLACK);</span><br><span class="line">           grandPa.setColour(ColourType.RED);</span><br><span class="line">           //以祖父节点为基准开始修正</span><br><span class="line">           insertFix(grandPa);</span><br><span class="line">       &#125;</span><br><span class="line">       //父节点是红色，叔叔节点是黑色</span><br><span class="line">       else &#123;</span><br><span class="line">           if (NodeType.LEFT == parentNodeType) &#123;</span><br><span class="line">               if (NodeType.RIGHT == currNodeType) &#123;</span><br><span class="line">                   leftRotate(parent);</span><br><span class="line">                   parent = currNode;</span><br><span class="line">               &#125;</span><br><span class="line">               parent.setColour(ColourType.BLACK);</span><br><span class="line">               grandPa.setColour(ColourType.RED);</span><br><span class="line">               rightRotate(grandPa);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               if (NodeType.LEFT == currNodeType) &#123;</span><br><span class="line">                   rightRotate(parent);</span><br><span class="line">                   parent = currNode;</span><br><span class="line">               &#125;</span><br><span class="line">               parent.setColour(ColourType.BLACK);</span><br><span class="line">               grandPa.setColour(ColourType.RED);</span><br><span class="line">               leftRotate(grandPa);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>#参考资料</p>
<blockquote>
<p>红黑树图片：<a href="https://blog.csdn.net/qq_34173549/article/details/79636764" target="_blank" rel="noopener">https://blog.csdn.net/qq_34173549/article/details/79636764</a><br>红黑树总结：<a href="https://m.imooc.com/article/247142" target="_blank" rel="noopener">https://m.imooc.com/article/247142</a><br>红黑树代码：<a href="https://www.cnblogs.com/skywang12345/p/3624343.html" target="_blank" rel="noopener">https://www.cnblogs.com/skywang12345/p/3624343.html</a><br>红黑树代码：<a href="https://www.cnblogs.com/ysocean/p/8004211.html" target="_blank" rel="noopener">https://www.cnblogs.com/ysocean/p/8004211.html</a><br>红黑树的删除：<a href="https://blog.csdn.net/qq_37169817/article/details/78880110" target="_blank" rel="noopener">https://blog.csdn.net/qq_37169817/article/details/78880110</a><br>红黑树的删除：<a href="https://blog.csdn.net/ChinaLeeSunnyBoy/article/details/79525456" target="_blank" rel="noopener">https://blog.csdn.net/ChinaLeeSunnyBoy/article/details/79525456</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/07/binarytree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/07/binarytree/" itemprop="url">二叉树</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-07T22:26:49+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/07/binarytree/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/07/binarytree/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><ul>
<li>路径：从一个节点到另一个节点所经过的节点顺序集合。</li>
<li>根：最顶端的节点。从根节点到其他节点都有一条唯一确定的路径。或者说到其他节点都需要从根节点出发。</li>
<li>层：从根节点开始定义，根节点位于第一层。根的子节点为第二层。以此类推。</li>
<li>深度：从根节点到某节点的路径长度。<strong>根节点的深度为0</strong>。</li>
<li>高度：某节点到叶子节点的最大路径长度。<strong>叶子节点的高度为0</strong>。</li>
<li>宽度：各层的最大节点数。如图1所示，第3层节点数做多，即树的宽度为4。</li>
<li>二叉树：每个节点最多有两个子节点的树。</li>
<li>二叉搜索树：若二叉树的左子树不空，则左子树所有节点的值都小于右子树的所有节点的值。若有子树不空，则右子树所有节点的值都大于子它根节点的值。</li>
<li><strong>二叉树第n层最多有2^(n-1)个节点。</strong></li>
<li><strong>二叉树第n层最多共有（2^n）-1个节点。</strong></li>
<li><strong>二叉树查找的时间复杂度是O(logn),底数为2。</strong></li>
</ul>
<p><img src="/2018/11/07/binarytree/tree-1.png" alt="二叉树-1"></p>
<h1 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h1><h2 id="先序遍历"><a href="#先序遍历" class="headerlink" title="先序遍历"></a>先序遍历</h2><p><img src="/2018/11/07/binarytree/preiterator.png" alt="二叉树-2"></p>
<h2 id="中序遍历"><a href="#中序遍历" class="headerlink" title="中序遍历"></a>中序遍历</h2><p><img src="/2018/11/07/binarytree/miditerator.png" alt="二叉树-3"></p>
<h2 id="后序遍历"><a href="#后序遍历" class="headerlink" title="后序遍历"></a>后序遍历</h2><p><img src="/2018/11/07/binarytree/postiterator.png" alt="二叉树-4"></p>
<h2 id="层序遍历"><a href="#层序遍历" class="headerlink" title="层序遍历"></a>层序遍历</h2><p><img src="/2018/11/07/binarytree/leveliterator.png" alt="二叉树-5"></p>
<p>层序遍历需要注意以下，因为遍历的时候先都是按照先左后右的顺序向下逐级遍历，故才有队列的方式来缓存当前根节点的子节点。</p>
<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><p><img src="/2018/11/07/binarytree/insert.png" alt="二叉树-6"></p>
<p>插入的时候需要满足二叉搜索树的性质，即左子树的所有节点均小于右子树的所有节点，故需要从根节点开始，与待插入的数据进行比较，小于根节点的从左子树找，大于等于根节点的从右子树找。直到找到一个符合新值的叶子节点位置。</p>
<h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><p><img src="/2018/11/07/binarytree/delete.png" alt="二叉树-7"></p>
<p>删除操作首先需要查找到目标节点，删除目标节点肯定会涉及到目标节点的父级节点，以及目标节点是父级节点的子节点类型（左子节点还是右子节点），所以在查询的过程中需要一并获取这些数据。之后需要根据目标节点的类型来进行删除。需要考虑目标节点是否有子节点、目标节点有一个子节点以及目标节点有两个子节点这三种场景来考虑。</p>
<h2 id="删除叶子"><a href="#删除叶子" class="headerlink" title="删除叶子"></a>删除叶子</h2><p><img src="/2018/11/07/binarytree/delete-3.png" alt="二叉树-10"></p>
<p><img src="/2018/11/07/binarytree/delete-1.png" alt="二叉树-8"></p>
<p>当目标节点没有子节点时（叶子），只需要将目标节点的父节点对应的子节点清空即可。即如果目标节点是父节点的左子树则清空父节点的左子节点。反之同反。</p>
<h2 id="目标节点有一个子树"><a href="#目标节点有一个子树" class="headerlink" title="目标节点有一个子树"></a>目标节点有一个子树</h2><p><img src="/2018/11/07/binarytree/delete-4.png" alt="二叉树-11"></p>
<p><img src="/2018/11/07/binarytree/delete-2.png" alt="二叉树-9"></p>
<p>当目标节点有一个子节点时，需要将父级节点的对应子节点指向目标节点的子节点即可。</p>
<h2 id="目标有两个子树"><a href="#目标有两个子树" class="headerlink" title="目标有两个子树"></a>目标有两个子树</h2><p><img src="/2018/11/07/binarytree/delete-5.png" alt="二叉树-12"></p>
<p>当目标节点有两个子节点时，这种场景比较复杂。由于二叉搜索树的性质，删除的目标节点删除后，需要找到一个节点来替代目标节点，而替代的节点需要是目标节点的后继节点即，比目标节点大的最小值。所以需要获取目标节点右子树的最小值也就是目标节点右子树的最左节点。</p>
<h3 id="后继节点是目标节点的右子节点"><a href="#后继节点是目标节点的右子节点" class="headerlink" title="后继节点是目标节点的右子节点"></a>后继节点是目标节点的右子节点</h3><p><img src="/2018/11/07/binarytree/delete-7.png" alt="二叉树-14"></p>
<p><img src="/2018/11/07/binarytree/delete-6.png" alt="二叉树-13"></p>
<p>当后继节点为目标节点右子节点，即目标节点的右子节点没有左子树的场景。这个时候，只需要将目标节点的父节点对应子节点指向后继节点即可。</p>
<h3 id="后继节点是目标节点右子树中的左子节点"><a href="#后继节点是目标节点右子树中的左子节点" class="headerlink" title="后继节点是目标节点右子树中的左子节点"></a>后继节点是目标节点右子树中的左子节点</h3><p><img src="/2018/11/07/binarytree/delete-8.png" alt="二叉树-15"></p>
<p><img src="/2018/11/07/binarytree/delete-9.png" alt="二叉树-16"></p>
<p>当目标节点的右子节点右左子树时，则后继节点为右子树的最左节点，所以需要首先遍历目标节点的右子树的左子树。找到最左节点。</p>
<h1 id="宽度"><a href="#宽度" class="headerlink" title="宽度"></a>宽度</h1><p><img src="/2018/11/07/binarytree/width.png" alt="二叉树-17"></p>
<p>主要还是通过层序遍历的方式来统计每一层节点的子节点个数。没遍历一层，都会构建新的子节点队列。通过比较每一层的子节点个数之和来获取最大值，从而获取宽度。</p>
<h1 id="深度"><a href="#深度" class="headerlink" title="深度"></a>深度</h1><p><img src="/2018/11/07/binarytree/deep.png" alt="二叉树-18"></p>
<p>利用二叉搜索树的性质，直接进行深度优先遍历查找目标节点，没向下遍历一次则累加，这样获取深度。</p>
<h1 id="高度"><a href="#高度" class="headerlink" title="高度"></a>高度</h1><p><img src="/2018/11/07/binarytree/height.png" alt="二叉树-19"></p>
<h1 id="转换成数组"><a href="#转换成数组" class="headerlink" title="转换成数组"></a>转换成数组</h1><p><img src="/2018/11/07/binarytree/toArray.png" alt="二叉树-20"></p>
<p>主要还是采用层序遍历的思路，将下一层的节点都存储在队列中，如果当前节点没有子节点，也需要将结果队列中存储元素。这样最终的结果队列会是按照满二叉树的元素来存储整个树的层序遍历结果。</p>
<h2 id="数组的缺陷"><a href="#数组的缺陷" class="headerlink" title="数组的缺陷"></a>数组的缺陷</h2><p>从代码中就可以看到，数组存储二叉树的时候，空的节点也会占用存储空间，同时如果涉及到删除操作，还会牵扯到数组中数据的平移，效率很低。</p>
<ul>
<li>数组中index位置 其左子节点为<strong>2index+1</strong> 右子节点为<strong>2index+2</strong> 父节点 <strong>(index-1)/2</strong></li>
</ul>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p><a href="https://github.com/gudulongao/datastructalgorithm/blob/master/src/main/java/binarytree/demo/BinaryTree.java" target="_blank" rel="noopener">https://github.com/gudulongao/datastructalgorithm/blob/master/src/main/java/binarytree/demo/BinaryTree.java</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>参考网址：<a href="https://www.cnblogs.com/ysocean/p/8032642.html" target="_blank" rel="noopener">https://www.cnblogs.com/ysocean/p/8032642.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/mysql-lock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/mysql-lock/" itemprop="url">Mysql锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-26T11:19:12+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql数据库/" itemprop="url" rel="index">
                    <span itemprop="name">MySql数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/26/mysql-lock/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/26/mysql-lock/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><h1 id="MVCC并发控制"><a href="#MVCC并发控制" class="headerlink" title="MVCC并发控制"></a>MVCC并发控制</h1><p>多版本并发控制（Multi-Version-Concurrency-Control）。<br>InnoDB存储引擎，当事务的隔离级别为可重复读(REPEATABLE-READ)时。对于每一行数据都增加了两个隐藏列，一列是存储创建该行数据的系统版本号，另一列是删除该行的系统版本号。</p>
<ul>
<li>新增时，行数据的创建版本号为当前事务对应的系统版本号，删除版本号为空。</li>
<li>查询时，只会查询到创建版本号小于等于当前事务的系统版本号，删除版本号未定义或者大于等于当前事务的版本号，即在当前事务开始时存在并且未删除的数据。</li>
<li>删除时，行数据的删除版本号为当前事务对应的系统版本号。</li>
<li>修改时，会新增一条数据，这条新数据的新增版本号为当前事务对应的系统版本号，删除版本号未定义。老数据的删除版本号为当前事务对应的系统版本号。</li>
</ul>
<p>这样保证了客重复读即在同一个事物中对于表的数据不会受到别的事务修改提交的影响。只会读取到当前事务创建时的数据状态。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>Mysql锁：<a href="https://blog.csdn.net/soonfly/article/details/70238902" target="_blank" rel="noopener">https://blog.csdn.net/soonfly/article/details/70238902</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpeg"
                alt="小磊砸" />
            
              <p class="site-author-name" itemprop="name">小磊砸</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">65</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小磊砸</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xiaoleiza.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
