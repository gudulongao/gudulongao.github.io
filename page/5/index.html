<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="小磊砸的布劳格">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="小磊砸的布劳格">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小磊砸的布劳格">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>小磊砸的布劳格</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小磊砸的布劳格</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/block/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/block/" itemprop="url">同步锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-16T23:21:44+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/锁/" itemprop="url" rel="index">
                    <span itemprop="name">锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/16/block/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/16/block/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="同步锁"><a href="#同步锁" class="headerlink" title="同步锁"></a>同步锁</h1><table>
<thead>
<tr>
<th>修饰区域</th>
<th>说明</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>修饰对象</td>
<td>对对象加锁</td>
<td><strong>对象锁</strong></td>
</tr>
<tr>
<td>修饰实例方法</td>
<td>对当前实例加锁</td>
<td><strong>this锁</strong></td>
</tr>
<tr>
<td>修饰静态方法</td>
<td>对当前类加锁</td>
<td><strong>类锁</strong></td>
</tr>
<tr>
<td>修饰类</td>
<td>对当前类加锁</td>
<td><strong>类锁</strong></td>
</tr>
</tbody>
</table>
<h1 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了了解synchronized的实现原理，需要事先对jvm对象的结构，moniter对象的结构有所了解。</p>
<h3 id="对象结构"><a href="#对象结构" class="headerlink" title="对象结构"></a>对象结构</h3><p><img src="/2019/02/16/block/object.png" alt="block"></p>
<p>jvm 中的对象主要由<strong>对象头、实例变量和对齐填充</strong>三个部分组成。</p>
<table>
<thead>
<tr>
<th>部分</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>对象头</td>
<td>对象主要存储对象运行时的数据(<strong>MarkWord</strong>)和元数据(<strong>KlassPointer</strong>)</td>
</tr>
<tr>
<td>实例变量</td>
<td>对象数据数据的存储区域</td>
</tr>
<tr>
<td>对齐填充</td>
<td>为了满足对象的大小是8字节的整数倍，进行填充大小的区域</td>
</tr>
</tbody>
</table>
<h4 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h4><p>其中对象头需要着重了解。<br>对象头由标记字段(<strong>MarkWord</strong>)和元数据指针(<strong>KlassPointer</strong>)两个部分组成。</p>
<table>
<thead>
<tr>
<th>区域</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>MarkWord</strong></td>
<td>当前对象的运行时数据，如哈希值，gc标志，锁标记等</td>
</tr>
<tr>
<td><strong>KlassPoniter</strong></td>
<td>指向当前对象所属的类元数据的指针</td>
</tr>
</tbody>
</table>
<p>MarkWord最后2位表明了当前对象的状态。不同的状态存储了不同的内容，如下表所示。</p>
<table>
<thead>
<tr>
<th>标识位</th>
<th>状态</th>
<th>存储内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>01</td>
<td>未锁定，可偏向</td>
<td>对象哈希值、对象分代年龄，偏向线程id，偏向时间戳</td>
</tr>
<tr>
<td>00</td>
<td>轻量级锁</td>
<td>指向LockRecord</td>
</tr>
<tr>
<td>10</td>
<td>重量锁</td>
<td>指向重量级锁</td>
</tr>
<tr>
<td>11</td>
<td>gc标志</td>
<td>空</td>
</tr>
</tbody>
</table>
<p><img src="/2019/02/16/block/markword.png" alt="block">  </p>
<p><strong>MarkWorkd中记录了monitor对象的地址。即每一个对象都拥有一个与之对应的monitor对象。</strong></p>
<h3 id="monitor对象"><a href="#monitor对象" class="headerlink" title="monitor对象"></a>monitor对象</h3><p>monitor对象的结构如下图所示。</p>
<p><img src="/2019/02/16/block/monitor-struct.png" alt="block"></p>
<p>结构说明如下图所示。</p>
<table>
<thead>
<tr>
<th>部分</th>
<th>说明</th>
<th>特征</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>count</strong></td>
<td>记录获取锁的线程数</td>
<td></td>
</tr>
<tr>
<td><strong>ContentionList</strong></td>
<td>所有竞争锁的线程都会进入到这个队列</td>
<td>多个</td>
</tr>
<tr>
<td><strong>EntryList</strong></td>
<td>从ContentionList中随机选择部分线程作为候选线程进入EntryList队列</td>
<td>多个</td>
</tr>
<tr>
<td><strong>Owner</strong></td>
<td>拥有当前锁的线程</td>
<td>一个</td>
</tr>
<tr>
<td><strong>OnDeck</strong></td>
<td>等待获取锁的线程，即候选线程</td>
<td>一个</td>
</tr>
<tr>
<td><strong>WaitSet</strong></td>
<td>等待当前对象的线程队列，调用当前对象的wait方法后，线程会进入当前对象的waitset队列</td>
<td>多个</td>
</tr>
</tbody>
</table>
<p><strong>contentionlist、entrylist、waitset队列中的线程都是阻塞状态</strong>。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="/2019/02/16/block/monitor.png" alt="block"></p>
<p>1、所有想要竞争锁的线程都会先进入到contentionlist队列中。<br>2、从contentionlist中将部分线程作为候选线程转移到entrylist队列中。<br>3、从entrylist队列中随机选择一个线程作为候选线程，OnDeck指向候选线程。如果锁没有被占用，count=0，则候选线程成功获取锁。这个时候owner指向拥有锁的线程，count+1。如果锁已被占用候选线程会等到锁被释放后才会拥有锁。<br>4、当拥有锁的线程再次请求加锁时（<strong>可重入</strong>），monitor对象会判断owner是否时指向当前线程，如果是，则属于重入的场景，只需要count+1即可。<br>5、如果拥有锁的线程释放锁，则count-1。（<strong>重入的线程重入几次就需要释放几次，count也会依次-1</strong>）</p>
<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="阻塞的代价"><a href="#阻塞的代价" class="headerlink" title="阻塞的代价"></a>阻塞的代价</h2><p>java的线程是映射到操作系统原生线程之上的，如果要阻塞或唤醒一个线程就需要操作系统介入，需要在用户态与核心态之间切换，这种切换会消耗大量的系统资源，因为用户态与内核态都有各自专用的内存空间，专用的寄存器等，用户态切换至内核态需要传递给许多变量、参数给内核，内核也需要保护好用户态在切换时的一些寄存器值、变量等，以便内核态调用结束后切换回用户态继续工作。  </p>
<blockquote>
<p>1、如果线程状态切换是一个高频操作时，这将会消耗很多CPU处理时间。<br>2、如果对于那些需要同步的简单的代码块，获取锁挂起操作消耗的时间比用户代码执行的时间还要长，这种同步策略显然非常糟糕的。  </p>
</blockquote>
<h2 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h2><p>当对象锁发生竞争时，如果owner线程能够在很短的时间释放锁，则竞争线程可以稍微的等一等（自旋，空循环），当owner线程释放锁后，自旋线程会立即获得锁。如果owner线程在超出了自旋阀值后还没有释放锁，则自旋线程停止自旋，进入阻塞状态。<strong>竞争不到锁会先自旋，实在不行才阻塞，尽量降低阻塞的可能性</strong>。  </p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>尽可能的降低锁进入阻塞状态的可能性。减少了内核态和用户态的切换，降低了线程切换造成的系统资源消耗。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p><strong>非公平</strong> 自旋锁在自旋后，如果锁被释放，会立即获取锁资源，相当于抢占了OnDeck(ReadThread)的资源。<br><strong>降低吞吐量</strong> 当占有锁执行的任务时间很长，或者锁的竞争很激烈的场景。锁短时间不会释放，而线程又因为自旋要白白消耗CPU时间片，别的线程又不能立即获得时间片。这无疑会降低系统的吞吐量。<strong>高并发并且线程任务耗时的这种场景建议都关闭自选锁</strong>   </p>
<p><img src="/2019/02/16/block/history.png" alt="block"></p>
<h2 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h2><p>偏向锁住要是提升无竞争场景下的加锁/解锁效率。<br>对于加锁/解锁，总会涉及到CAS操作。而<strong>频繁的CAS操作会导致总线风暴从而导致本地延迟。偏向锁的意义在于尽可能的减少CAS操作</strong>。因此偏向锁的想法是一旦线程第一次获得了监视对象，之后让监视对象“偏向”这个线程，之后的多次调用则可以避免CAS操作。<br><strong>偏向锁，偏向第一次拥有锁的线程，后续的运行过程中，如果没有别的竞争线程，则加锁/解锁不会有CAS操作。一旦有别的竞争线程，持有偏向锁的线程会被挂起，jvm会清楚线程的偏向锁，将偏向锁升级为轻量级锁。</strong></p>
<h3 id="偏向锁的获取"><a href="#偏向锁的获取" class="headerlink" title="偏向锁的获取"></a>偏向锁的获取</h3><blockquote>
<p>1、对象锁的MarkWord偏向锁标志=1，锁标志=01，表明当前锁对象是可偏向的。<br>2、判断MarkWord的偏向锁id是否是当前线程，如果是，则直接进入同步代码块。不是，则通过CAS操作在MarkWord中存储当前线程id。<br>3、如果CAS操作成功，则直接进入同步代码块，如果失败，则表明有竞争，拥有偏向锁的线程会挂起，偏向锁会升级为轻量锁，阻塞的线程会竞争轻量锁，竞争成功的线程进入同步代码块。</p>
</blockquote>
<p><img src="/2019/02/16/block/biasedlock.png" alt="block"></p>
<h3 id="偏向锁的释放"><a href="#偏向锁的释放" class="headerlink" title="偏向锁的释放"></a>偏向锁的释放</h3><p>如上图所示，偏向锁遇到有竞争时，拥有偏向锁的线程会挂起，同时会撤销偏向锁。偏向锁的撤销，还会导致stop the world操作，导致性能下降。<br><strong>偏向锁适合无锁竞争的场景下使用</strong>。</p>
<h2 id="轻量锁"><a href="#轻量锁" class="headerlink" title="轻量锁"></a>轻量锁</h2><p>轻量级锁是由偏向锁升级而来的。偏向锁是只有一个线程加锁的情况，当有第二个线程要竞争锁，偏向锁会升级为轻量级锁。</p>
<h3 id="轻量级锁的获取"><a href="#轻量级锁的获取" class="headerlink" title="轻量级锁的获取"></a>轻量级锁的获取</h3><p><img src="/2019/02/16/block/biasedlock2lightlock.png" alt="block"></p>
<blockquote>
<p>1、每一个线程在竞争锁的时候，首先会检查MarkWord中记录的threadid是否是当前线程<strong>(MarkWord锁标志=01)</strong>。如果是，则属于偏向锁，不需要进行锁的申请等操作，直接进入同步代码块。<br>2、如果MarkWord中的threadid不是当前线程。则说明当前存在竞争。这个时候，<strong>通过CAS操作</strong>，根据MarkWord中存储的threadid，通知拥有偏向锁的线程释放偏向锁，清空MarkWord信息，并挂起。同时将偏向锁升级为轻量级锁<strong>(MarkWord锁标志=00)</strong>。<br>3、两个竞争的线程都会在栈帧中创建LockRecord空间。<strong>通过CAS操作</strong>，将共享对象的MarkWord拷贝到LockRecord（官方称之为Displaced Mark Word），同时将对象锁的MarkWord指向LockRecord。CAS操作成功的线程竞争到轻量级锁，可以继续进入同步代码块。CAS操作失败的线程进行自旋。<br>4、自旋线程，自旋后如果成功获取锁（即之前拥有轻量级锁的线程释放了锁）这个时候，自旋线程继续保持轻量级锁进入同步代码块。自旋后如果没有获取锁（即之前拥有轻量级锁的线程还未执行完毕，没有释放锁），之前拥有轻量级锁的线程会挂起，轻量级锁会膨胀为重量级锁<strong>（MarkWord锁=10）</strong>。这个时候所有竞争线程会竞争重量级锁。</p>
</blockquote>
<h3 id="轻量级锁的释放"><a href="#轻量级锁的释放" class="headerlink" title="轻量级锁的释放"></a>轻量级锁的释放</h3><h2 id="重量锁"><a href="#重量锁" class="headerlink" title="重量锁"></a>重量锁</h2><p><img src="/2019/02/16/block/lightlock2wightlock.png" alt="block"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>锁：<a href="http://www.cnblogs.com/charlesblc/p/5994162.html" target="_blank" rel="noopener">http://www.cnblogs.com/charlesblc/p/5994162.html</a><br>对象头：<a href="https://blog.csdn.net/zhoufanyang_china/article/details/54601311" target="_blank" rel="noopener">https://blog.csdn.net/zhoufanyang_china/article/details/54601311</a><br>同步锁：<a href="https://www.cnblogs.com/mingyao123/p/7424911.html" target="_blank" rel="noopener">https://www.cnblogs.com/mingyao123/p/7424911.html</a><br>偏向锁/轻量级锁/重量锁：<a href="https://blog.csdn.net/zqz_zqz/article/details/70233767" target="_blank" rel="noopener">https://blog.csdn.net/zqz_zqz/article/details/70233767</a><br>加锁/释放锁的过程：<a href="https://blog.csdn.net/luo532046043/article/details/82883598" target="_blank" rel="noopener">https://blog.csdn.net/luo532046043/article/details/82883598</a><br>CAS操作导致总线风暴（CAS及SMP架构）：<a href="https://blog.csdn.net/chen77716/article/details/6618779" target="_blank" rel="noopener">https://blog.csdn.net/chen77716/article/details/6618779</a>   </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/15/thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/15/thread/" itemprop="url">线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-15T23:21:44+08:00">
                2019-02-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/高并发/" itemprop="url" rel="index">
                    <span itemprop="name">高并发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/15/thread/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/02/15/thread/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>线程的状态： <a href="https://www.jianshu.com/p/f65ea68a4a7f" target="_blank" rel="noopener">https://www.jianshu.com/p/f65ea68a4a7f</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/26/zookeeper-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/26/zookeeper-1/" itemprop="url">ZooKeeper安装部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-26T23:19:53+08:00">
                2018-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ZooKeeper/" itemprop="url" rel="index">
                    <span itemprop="name">ZooKeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/26/zookeeper-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/26/zookeeper-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>下载地址：<a href="https://archive.apache.org/dist/zookeeper/" target="_blank" rel="noopener">https://archive.apache.org/dist/zookeeper/</a>  </p>
</blockquote>
<h2 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf zookeeper.tar</span><br></pre></td></tr></table></figure>
<h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><p>将zookeeper压缩包解压之后，conf目录下有样例配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line"># 心跳检测时间（单位毫秒）</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line"># 主从同步时间周期（周期单位为心跳检测的时间）</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line"># 主从交互时等待的时间周期（周期单位为心跳检测时间）</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line"># 数据目录</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk</span><br><span class="line"># 日志目录</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line"># 端口</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br></pre></td></tr></table></figure>
<p>主要的参数如下表所示：</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tickTime</td>
<td>心跳检测时间，毫秒级，zookeeper所有的时间都是七整数倍</td>
</tr>
<tr>
<td>initLimit</td>
<td>在leader选举之后，follower与leader同步需要的时间，当leader数据很多时，这个值需要相应的调整</td>
</tr>
<tr>
<td>syncLimit</td>
<td>表示follower,leader与obsrver交互的最大时间，在与leader同步完成之后，正常转发请求的时间</td>
</tr>
<tr>
<td>dataDir</td>
<td>内存数据快照存储地址</td>
</tr>
<tr>
<td>dataLogDir</td>
<td>事务日志存储地址</td>
</tr>
<tr>
<td>clientPort</td>
<td>zookeeper监听客户端连接的端口</td>
</tr>
</tbody>
</table>
<h2 id="操作指令"><a href="#操作指令" class="headerlink" title="操作指令"></a>操作指令</h2><p>zookeeper的相关操作都是基于bin目录下的shell脚本来执行的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 启动服务（默认加载conf目录下的zoo.cfg）</span><br><span class="line">zkServer.sh start </span><br><span class="line"># 查看服务状态</span><br><span class="line">zkServer.sh status</span><br><span class="line"># 停止服务</span><br><span class="line">zkServer.sh stop</span><br><span class="line"># 客户端连接</span><br><span class="line">zkCli.sh</span><br></pre></td></tr></table></figure>
<h2 id="单机伪集群部署"><a href="#单机伪集群部署" class="headerlink" title="单机伪集群部署"></a>单机伪集群部署</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><strong>zookeeper集群配置最小需要3个节点</strong>。单机伪集群部署是在同一台机器上通过启动三个zookeeper进程来实现集群效果，需要保证三个zookeeper进程端口不能冲突，相应目录也要隔离开。故在conf目录创建zk1.cfg，zk2.cfg和zk3.cfg三 个配置文件。<br>zk1.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk1</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk1</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>zk2.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk2</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk2</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2182</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>zk3.cfg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use /tmp for storage, /tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir=/Users/tanglei/step/zookeeper/dataDir/zk3</span><br><span class="line">dataLogDir=/Users/tanglei/step/zookeeper/dataLogDir/zk3</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2183</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns=60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount=3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval=1</span><br><span class="line"></span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br></pre></td></tr></table></figure>
<p>集群配置与单例配置唯一的区别是配置文件中增加了集群中节点的配置。</p>
<p><img src="/2018/11/26/zookeeper-1/groupsetting.png" alt="集群配置">  </p>
<p>简单介绍一下配置的含义：<strong>server.[节点id]=[ip]:[心跳通信端口]:[选举同学端口]</strong>  </p>
<p>这三个配置文件的clientPort端口，dataDir和dataLogDir目录都各自不相同，保证三个zookeeper进程能够顺利启动。<br>接下来需要在三个配置文件的dataDir中创建myid文件，文件内容是节点id。<br>在zookeeper根目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 1&gt; dataDir/zk1/myid</span><br><span class="line">echo 2&gt; dataDir/zk2/myid</span><br><span class="line">echo 3&gt; dataDir/zk3/myid</span><br></pre></td></tr></table></figure>
<h3 id="启停检测"><a href="#启停检测" class="headerlink" title="启停检测"></a>启停检测</h3><p>在bin目录下，以节点1为例，其他节点类似。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动节点1</span><br><span class="line">zkServer.sh start ../conf/zk1.cfg </span><br><span class="line"># 检测节点1</span><br><span class="line">zkServer.sh status ../conf/zk1.cfg</span><br><span class="line"># 停止节点1</span><br><span class="line">zkServer.sh stop ../conf/zk1.cfg</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p><a href="https://www.cnblogs.com/leocook/p/zk_1.html" target="_blank" rel="noopener">https://www.cnblogs.com/leocook/p/zk_1.html</a><br>zookeeper学习博客：<a href="https://www.cnblogs.com/qingyunzong/p/8618965.html" target="_blank" rel="noopener">https://www.cnblogs.com/qingyunzong/p/8618965.html</a><br>zookeeper安装：<a href="https://www.jianshu.com/p/5491d16e6abd" target="_blank" rel="noopener">https://www.jianshu.com/p/5491d16e6abd</a><br>zookeeper伪集群：<a href="https://www.cnblogs.com/crazylqy/p/7119030.html" target="_blank" rel="noopener">https://www.cnblogs.com/crazylqy/p/7119030.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/14/redblacktree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/14/redblacktree/" itemprop="url">红黑树</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-14T23:02:25+08:00">
                2018-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/14/redblacktree/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/14/redblacktree/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h1><p>二叉搜索树，能够提供较好的查找，插入以及删除的效率。但是当插入的数据都是有序的，这会导致整个二叉搜索树退化为链表。当查找数据的时候由原来的二分查找变成了循环遍历。这种效率降低是因为树不够平衡导致的。红黑树就是对所有的节点增加红黑两种颜色，同时节点直接保持一种颜色的准则，在插入，删除等操作的同时也要维持这个准则，这样红黑树能够在处理排序数据时也能保证树的平衡，能够提供较好的查找效率。</p>
<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><ul>
<li>所有节点要么是红色，要么是黑色</li>
<li>根节点必须是黑色</li>
<li>所有叶子节点的路径中不能有连续的红色节点（红色节点的子节点必须是黑色，反之不一定）</li>
<li>所有叶子节点的路径中黑色个数相同（黑色高度一致）</li>
</ul>
<h1 id="左旋"><a href="#左旋" class="headerlink" title="左旋"></a>左旋</h1><p><img src="/2018/11/14/redblacktree/leftretato.png" alt="左旋"></p>
<p>如图所示。左旋会将当前节点的右节点作为后继节点，当前节点作为后继节点的左子树。</p>
<p><img src="/2018/11/14/redblacktree/redblacktree-1.png" alt="红黑树-1"></p>
<h1 id="右旋"><a href="#右旋" class="headerlink" title="右旋"></a>右旋</h1><p><img src="/2018/11/14/redblacktree/rightretato.png" alt="右旋"></p>
<p>如图所示，右旋会将当亲节点的左子节点为后继节点，当前节点作为后继节点的右子树。</p>
<p><img src="/2018/11/14/redblacktree/redblacktree-2.png" alt="红黑树-2"></p>
<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><p>插入节点逻辑比较复杂。因为要保证插入新节点后整个红黑树还能够保持红黑树的定义。<br>我们默认新插入的节点都是红色的，因为新节点是红色的代价最小。当节点是黑色是一定会使得黑色高度发生变化。而当新节点是红色，当父节点是黑色，则不违背定义，但如果父节点是红色，我们可以通过很小的代价来修正。</p>
<h2 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h2><p>当插入的新节点（红色）后，可能会违背红黑树的定义，这个时候需要进行修正。</p>
<h3 id="父节点为黑色"><a href="#父节点为黑色" class="headerlink" title="父节点为黑色"></a>父节点为黑色</h3><p><img src="/2018/11/14/redblacktree/insert-1.png" alt="插入-1"></p>
<p>这种场景不需要做修正。并不违反红黑树的定义。</p>
<h3 id="父节点为红色，叔叔节点为红色"><a href="#父节点为红色，叔叔节点为红色" class="headerlink" title="父节点为红色，叔叔节点为红色"></a>父节点为红色，叔叔节点为红色</h3><p><img src="/2018/11/14/redblacktree/insert-2.png" alt="插入-2"></p>
<p>这种场景只需要将父节点，叔叔节点都变成黑色，将祖父节点变为红色，再以祖父节点为基准开始修正（递归）。</p>
<h3 id="父节点为红色，叔叔节点为黑色"><a href="#父节点为红色，叔叔节点为黑色" class="headerlink" title="父节点为红色，叔叔节点为黑色"></a>父节点为红色，叔叔节点为黑色</h3><p>当父节点为红色，叔叔节点为黑色时，需要按如下四种场景来进行修正。</p>
<h4 id="父节点是左子节点，新节点为左子节点"><a href="#父节点是左子节点，新节点为左子节点" class="headerlink" title="父节点是左子节点，新节点为左子节点"></a>父节点是左子节点，新节点为左子节点</h4><p><img src="/2018/11/14/redblacktree/insert-3.png" alt="插入-3"></p>
<p>这种场景，需要先将父节点变为黑色，将祖父节点变为红色。再以祖父节点为基准进行右旋。</p>
<h4 id="父节点是右子节点，新节点是右子节点"><a href="#父节点是右子节点，新节点是右子节点" class="headerlink" title="父节点是右子节点，新节点是右子节点"></a>父节点是右子节点，新节点是右子节点</h4><p><img src="/2018/11/14/redblacktree/insert-4.png" alt="插入-4"></p>
<p>这种场景，需要先将父节点变为黑色，将祖父节点变为红色，再以祖父节点为基准进行左旋。</p>
<h4 id="父节点是左子节点，新节点是右子节点"><a href="#父节点是左子节点，新节点是右子节点" class="headerlink" title="父节点是左子节点，新节点是右子节点"></a>父节点是左子节点，新节点是右子节点</h4><p><img src="/2018/11/14/redblacktree/insert-5.png" alt="插入-5"></p>
<p>这种场景，需要先以父节点为基准进行左旋。这个时候整个树会变成父节点时左子节点，新节点也是左子节点的场景，只是新节点是父节点的父节点。<br>这个时候同理，将新节点变为黑色，将祖父节点变为红色，再以祖父节点为基准节点进行右旋。</p>
<h4 id="父节点是右子节点，新节点是左子节点"><a href="#父节点是右子节点，新节点是左子节点" class="headerlink" title="父节点是右子节点，新节点是左子节点"></a>父节点是右子节点，新节点是左子节点</h4><p><img src="/2018/11/14/redblacktree/insert-6.png" alt="插入-6"></p>
<p>这种场景，需要先以父节点为基准进行右旋。这个时候整个树就会变成父节点是右子节点，新节点也是右子节点的场景。只是新节点是父节点的父节点。<br>这个时候同理，将新节点变为黑色，将祖父节点变为红色，再以祖父节点为基准节点进行左旋。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 新增后修正</span><br><span class="line">    *</span><br><span class="line">    * @param currNode 当前节点</span><br><span class="line">    */</span><br><span class="line">   private void insertFix(RedBlackNode&lt;T&gt; currNode) throws Exception &#123;</span><br><span class="line">       NodeType currNodeType = currNode.nodeType();</span><br><span class="line">       //获取父级节点</span><br><span class="line">       RedBlackNode&lt;T&gt; parent = currNode.getParent();</span><br><span class="line">       if (parent == null) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //获取祖父节点</span><br><span class="line">       RedBlackNode&lt;T&gt; grandPa = parent.getParent();</span><br><span class="line">       if (grandPa == null) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //父节点的颜色</span><br><span class="line">       ColourType parentColour = parent.getColour();</span><br><span class="line">       //父节点是黑色不做处理</span><br><span class="line">       if (ColourType.BLACK == parentColour) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       //获取父级节点的节点类型</span><br><span class="line">       NodeType parentNodeType = parent.nodeType();</span><br><span class="line">       //获取叔叔节点</span><br><span class="line">       RedBlackNode&lt;T&gt; uncale = getUncaleNode(currNode);</span><br><span class="line">       ColourType uncaleColour = uncale == null ? null : uncale.getColour();</span><br><span class="line">       //父节点是红色，叔叔节点是红色,直接变更父节点与叔叔节点的颜色，修改祖父节点的颜色</span><br><span class="line">       if (ColourType.RED == uncaleColour) &#123;</span><br><span class="line">           parent.setColour(ColourType.BLACK);</span><br><span class="line">           uncale.setColour(ColourType.BLACK);</span><br><span class="line">           grandPa.setColour(ColourType.RED);</span><br><span class="line">           //以祖父节点为基准开始修正</span><br><span class="line">           insertFix(grandPa);</span><br><span class="line">       &#125;</span><br><span class="line">       //父节点是红色，叔叔节点是黑色</span><br><span class="line">       else &#123;</span><br><span class="line">           if (NodeType.LEFT == parentNodeType) &#123;</span><br><span class="line">               if (NodeType.RIGHT == currNodeType) &#123;</span><br><span class="line">                   leftRotate(parent);</span><br><span class="line">                   parent = currNode;</span><br><span class="line">               &#125;</span><br><span class="line">               parent.setColour(ColourType.BLACK);</span><br><span class="line">               grandPa.setColour(ColourType.RED);</span><br><span class="line">               rightRotate(grandPa);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               if (NodeType.LEFT == currNodeType) &#123;</span><br><span class="line">                   rightRotate(parent);</span><br><span class="line">                   parent = currNode;</span><br><span class="line">               &#125;</span><br><span class="line">               parent.setColour(ColourType.BLACK);</span><br><span class="line">               grandPa.setColour(ColourType.RED);</span><br><span class="line">               leftRotate(grandPa);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>#参考资料</p>
<blockquote>
<p>红黑树图片：<a href="https://blog.csdn.net/qq_34173549/article/details/79636764" target="_blank" rel="noopener">https://blog.csdn.net/qq_34173549/article/details/79636764</a><br>红黑树总结：<a href="https://m.imooc.com/article/247142" target="_blank" rel="noopener">https://m.imooc.com/article/247142</a><br>红黑树代码：<a href="https://www.cnblogs.com/skywang12345/p/3624343.html" target="_blank" rel="noopener">https://www.cnblogs.com/skywang12345/p/3624343.html</a><br>红黑树代码：<a href="https://www.cnblogs.com/ysocean/p/8004211.html" target="_blank" rel="noopener">https://www.cnblogs.com/ysocean/p/8004211.html</a><br>红黑树的删除：<a href="https://blog.csdn.net/qq_37169817/article/details/78880110" target="_blank" rel="noopener">https://blog.csdn.net/qq_37169817/article/details/78880110</a><br>红黑树的删除：<a href="https://blog.csdn.net/ChinaLeeSunnyBoy/article/details/79525456" target="_blank" rel="noopener">https://blog.csdn.net/ChinaLeeSunnyBoy/article/details/79525456</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/07/binarytree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/07/binarytree/" itemprop="url">二叉树</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-07T22:26:49+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/07/binarytree/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/07/binarytree/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><ul>
<li>路径：从一个节点到另一个节点所经过的节点顺序集合。</li>
<li>根：最顶端的节点。从根节点到其他节点都有一条唯一确定的路径。或者说到其他节点都需要从根节点出发。</li>
<li>层：从根节点开始定义，根节点位于第一层。根的子节点为第二层。以此类推。</li>
<li>深度：从根节点到某节点的路径长度。<strong>根节点的深度为0</strong>。</li>
<li>高度：某节点到叶子节点的最大路径长度。<strong>叶子节点的高度为0</strong>。</li>
<li>宽度：各层的最大节点数。如图1所示，第3层节点数做多，即树的宽度为4。</li>
<li>二叉树：每个节点最多有两个子节点的树。</li>
<li>二叉搜索树：若二叉树的左子树不空，则左子树所有节点的值都小于右子树的所有节点的值。若有子树不空，则右子树所有节点的值都大于子它根节点的值。</li>
<li><strong>二叉树第n层最多有2^(n-1)个节点。</strong></li>
<li><strong>二叉树第n层最多共有（2^n）-1个节点。</strong></li>
<li><strong>二叉树查找的时间复杂度是O(logn),底数为2。</strong></li>
</ul>
<p><img src="/2018/11/07/binarytree/tree-1.png" alt="二叉树-1"></p>
<h1 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h1><h2 id="先序遍历"><a href="#先序遍历" class="headerlink" title="先序遍历"></a>先序遍历</h2><p><img src="/2018/11/07/binarytree/preiterator.png" alt="二叉树-2"></p>
<h2 id="中序遍历"><a href="#中序遍历" class="headerlink" title="中序遍历"></a>中序遍历</h2><p><img src="/2018/11/07/binarytree/miditerator.png" alt="二叉树-3"></p>
<h2 id="后序遍历"><a href="#后序遍历" class="headerlink" title="后序遍历"></a>后序遍历</h2><p><img src="/2018/11/07/binarytree/postiterator.png" alt="二叉树-4"></p>
<h2 id="层序遍历"><a href="#层序遍历" class="headerlink" title="层序遍历"></a>层序遍历</h2><p><img src="/2018/11/07/binarytree/leveliterator.png" alt="二叉树-5"></p>
<p>层序遍历需要注意以下，因为遍历的时候先都是按照先左后右的顺序向下逐级遍历，故才有队列的方式来缓存当前根节点的子节点。</p>
<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><p><img src="/2018/11/07/binarytree/insert.png" alt="二叉树-6"></p>
<p>插入的时候需要满足二叉搜索树的性质，即左子树的所有节点均小于右子树的所有节点，故需要从根节点开始，与待插入的数据进行比较，小于根节点的从左子树找，大于等于根节点的从右子树找。直到找到一个符合新值的叶子节点位置。</p>
<h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><p><img src="/2018/11/07/binarytree/delete.png" alt="二叉树-7"></p>
<p>删除操作首先需要查找到目标节点，删除目标节点肯定会涉及到目标节点的父级节点，以及目标节点是父级节点的子节点类型（左子节点还是右子节点），所以在查询的过程中需要一并获取这些数据。之后需要根据目标节点的类型来进行删除。需要考虑目标节点是否有子节点、目标节点有一个子节点以及目标节点有两个子节点这三种场景来考虑。</p>
<h2 id="删除叶子"><a href="#删除叶子" class="headerlink" title="删除叶子"></a>删除叶子</h2><p><img src="/2018/11/07/binarytree/delete-3.png" alt="二叉树-10"></p>
<p><img src="/2018/11/07/binarytree/delete-1.png" alt="二叉树-8"></p>
<p>当目标节点没有子节点时（叶子），只需要将目标节点的父节点对应的子节点清空即可。即如果目标节点是父节点的左子树则清空父节点的左子节点。反之同反。</p>
<h2 id="目标节点有一个子树"><a href="#目标节点有一个子树" class="headerlink" title="目标节点有一个子树"></a>目标节点有一个子树</h2><p><img src="/2018/11/07/binarytree/delete-4.png" alt="二叉树-11"></p>
<p><img src="/2018/11/07/binarytree/delete-2.png" alt="二叉树-9"></p>
<p>当目标节点有一个子节点时，需要将父级节点的对应子节点指向目标节点的子节点即可。</p>
<h2 id="目标有两个子树"><a href="#目标有两个子树" class="headerlink" title="目标有两个子树"></a>目标有两个子树</h2><p><img src="/2018/11/07/binarytree/delete-5.png" alt="二叉树-12"></p>
<p>当目标节点有两个子节点时，这种场景比较复杂。由于二叉搜索树的性质，删除的目标节点删除后，需要找到一个节点来替代目标节点，而替代的节点需要是目标节点的后继节点即，比目标节点大的最小值。所以需要获取目标节点右子树的最小值也就是目标节点右子树的最左节点。</p>
<h3 id="后继节点是目标节点的右子节点"><a href="#后继节点是目标节点的右子节点" class="headerlink" title="后继节点是目标节点的右子节点"></a>后继节点是目标节点的右子节点</h3><p><img src="/2018/11/07/binarytree/delete-7.png" alt="二叉树-14"></p>
<p><img src="/2018/11/07/binarytree/delete-6.png" alt="二叉树-13"></p>
<p>当后继节点为目标节点右子节点，即目标节点的右子节点没有左子树的场景。这个时候，只需要将目标节点的父节点对应子节点指向后继节点即可。</p>
<h3 id="后继节点是目标节点右子树中的左子节点"><a href="#后继节点是目标节点右子树中的左子节点" class="headerlink" title="后继节点是目标节点右子树中的左子节点"></a>后继节点是目标节点右子树中的左子节点</h3><p><img src="/2018/11/07/binarytree/delete-8.png" alt="二叉树-15"></p>
<p><img src="/2018/11/07/binarytree/delete-9.png" alt="二叉树-16"></p>
<p>当目标节点的右子节点右左子树时，则后继节点为右子树的最左节点，所以需要首先遍历目标节点的右子树的左子树。找到最左节点。</p>
<h1 id="宽度"><a href="#宽度" class="headerlink" title="宽度"></a>宽度</h1><p><img src="/2018/11/07/binarytree/width.png" alt="二叉树-17"></p>
<p>主要还是通过层序遍历的方式来统计每一层节点的子节点个数。没遍历一层，都会构建新的子节点队列。通过比较每一层的子节点个数之和来获取最大值，从而获取宽度。</p>
<h1 id="深度"><a href="#深度" class="headerlink" title="深度"></a>深度</h1><p><img src="/2018/11/07/binarytree/deep.png" alt="二叉树-18"></p>
<p>利用二叉搜索树的性质，直接进行深度优先遍历查找目标节点，没向下遍历一次则累加，这样获取深度。</p>
<h1 id="高度"><a href="#高度" class="headerlink" title="高度"></a>高度</h1><p><img src="/2018/11/07/binarytree/height.png" alt="二叉树-19"></p>
<h1 id="转换成数组"><a href="#转换成数组" class="headerlink" title="转换成数组"></a>转换成数组</h1><p><img src="/2018/11/07/binarytree/toArray.png" alt="二叉树-20"></p>
<p>主要还是采用层序遍历的思路，将下一层的节点都存储在队列中，如果当前节点没有子节点，也需要将结果队列中存储元素。这样最终的结果队列会是按照满二叉树的元素来存储整个树的层序遍历结果。</p>
<h2 id="数组的缺陷"><a href="#数组的缺陷" class="headerlink" title="数组的缺陷"></a>数组的缺陷</h2><p>从代码中就可以看到，数组存储二叉树的时候，空的节点也会占用存储空间，同时如果涉及到删除操作，还会牵扯到数组中数据的平移，效率很低。</p>
<ul>
<li>数组中index位置 其左子节点为<strong>2index+1</strong> 右子节点为<strong>2index+2</strong> 父节点 <strong>(index-1)/2</strong></li>
</ul>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p><a href="https://github.com/gudulongao/datastructalgorithm/blob/master/src/main/java/binarytree/demo/BinaryTree.java" target="_blank" rel="noopener">https://github.com/gudulongao/datastructalgorithm/blob/master/src/main/java/binarytree/demo/BinaryTree.java</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>参考网址：<a href="https://www.cnblogs.com/ysocean/p/8032642.html" target="_blank" rel="noopener">https://www.cnblogs.com/ysocean/p/8032642.html</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/26/mysql-lock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/26/mysql-lock/" itemprop="url">Mysql锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-26T11:19:12+08:00">
                2018-09-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql数据库/" itemprop="url" rel="index">
                    <span itemprop="name">MySql数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/26/mysql-lock/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/26/mysql-lock/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><h1 id="MVCC并发控制"><a href="#MVCC并发控制" class="headerlink" title="MVCC并发控制"></a>MVCC并发控制</h1><p>多版本并发控制（Multi-Version-Concurrency-Control）。<br>InnoDB存储引擎，当事务的隔离级别为可重复读(REPEATABLE-READ)时。对于每一行数据都增加了两个隐藏列，一列是存储创建该行数据的系统版本号，另一列是删除该行的系统版本号。</p>
<ul>
<li>新增时，行数据的创建版本号为当前事务对应的系统版本号，删除版本号为空。</li>
<li>查询时，只会查询到创建版本号小于等于当前事务的系统版本号，删除版本号未定义或者大于等于当前事务的版本号，即在当前事务开始时存在并且未删除的数据。</li>
<li>删除时，行数据的删除版本号为当前事务对应的系统版本号。</li>
<li>修改时，会新增一条数据，这条新数据的新增版本号为当前事务对应的系统版本号，删除版本号未定义。老数据的删除版本号为当前事务对应的系统版本号。</li>
</ul>
<p>这样保证了客重复读即在同一个事物中对于表的数据不会受到别的事务修改提交的影响。只会读取到当前事务创建时的数据状态。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>Mysql锁：<a href="https://blog.csdn.net/soonfly/article/details/70238902" target="_blank" rel="noopener">https://blog.csdn.net/soonfly/article/details/70238902</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/mac-help/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/mac-help/" itemprop="url">Mac 操作笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T23:45:32+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mac系统/" itemprop="url" rel="index">
                    <span itemprop="name">Mac系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/25/mac-help/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/25/mac-help/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h1><h2 id="查看IP"><a href="#查看IP" class="headerlink" title="查看IP"></a>查看IP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig |grep &quot;inet &quot;|grep -v 127.0.0.1</span><br></pre></td></tr></table></figure>
<p><img src="/2018/09/25/mac-help/ifconfig.png" alt="查看ip"></p>
<h2 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh username@host</span><br></pre></td></tr></table></figure>
<h2 id="下载-上传文件"><a href="#下载-上传文件" class="headerlink" title="下载/上传文件"></a>下载/上传文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 下载</span><br><span class="line">scp username@host:remotepath localpatch</span><br><span class="line"></span><br><span class="line"># 上传</span><br><span class="line">scp localpath username@host:remotepath</span><br></pre></td></tr></table></figure>
<h1 id="升级后问题"><a href="#升级后问题" class="headerlink" title="升级后问题"></a>升级后问题</h1><h2 id="missing-xcrun"><a href="#missing-xcrun" class="headerlink" title="missing xcrun"></a>missing xcrun</h2><h3 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h3><p><img src="/2018/09/25/mac-help/error-1.png" alt="包装生成线程安全的hashmap"></p>
<h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/25/transection-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/transection-isolation/" itemprop="url">Mysql事务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T14:24:46+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql数据库/" itemprop="url" rel="index">
                    <span itemprop="name">MySql数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/25/transection-isolation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/25/transection-isolation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>事务是数据库并发控制的基本单元。<strong>在Mysql数据库中，只有InnoDB存储引擎支持事务</strong>。</p>
<h1 id="事务的属性"><a href="#事务的属性" class="headerlink" title="事务的属性"></a>事务的属性</h1><ul>
<li><strong>原子性(Atomicity)</strong>：事务中的操作要么全部执行成功要么全部执行失败。</li>
<li><strong>一致性(consistency)</strong>：事务执行前后，数据库中的数据都满足数据的完整性，符合业务需求(比如转账操作，一个账户的钱减少另一个账户的钱相应的减少。这种业务操作需要在一个事务中，这样在转账操作才会符合我们的业务需求)。  </li>
<li><strong>隔离型(isolation)</strong>：事务之间是隔离的，互相不影响的。</li>
<li><strong>持久性(durability)</strong>：事务提交后，对于数据库的修改是永久性的。</li>
</ul>
<h1 id="事务并发问题"><a href="#事务并发问题" class="headerlink" title="事务并发问题"></a>事务并发问题</h1><ul>
<li>更新丢失：两个事务A，B同时修改数据2，事务A将2修改为3，事务B将2修改为1，事务A提交了，事务B回滚了，则会将数据回滚到初始值2，即丢失了事务A的修改。</li>
<li>脏读：事务A读取了事务B未提交修改的数据，后续事务B回滚，则A读取的数据为脏数据。</li>
<li>不可重复读：事务多次读取同一数据但是结果不一致。事务A多次读取一数据，但是在这个过程中，事务B不断的修改这一数据，所以导致事务A每次读取的数据都不一致。<strong>修改操作</strong>会导致不可重复读。</li>
<li>幻读：事务A在统计某张表的总数时，事务B不断的插入数据，导致事务A读取的总数不对。<strong>新增或者删除操作</strong>会导致幻读。</li>
</ul>
<h1 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h1><table>
<thead>
<tr>
<th>类型</th>
<th style="text-align:center">更新丢失</th>
<th style="text-align:center">脏读</th>
<th style="text-align:center">不可重复读</th>
<th style="text-align:center">幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>读未提交(read-uncommited)</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
</tr>
<tr>
<td>读提交(read-commited)</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
</tr>
<tr>
<td>可重复读(repeatble-read)</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✅</td>
</tr>
<tr>
<td>串行化(serializable)</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">❌</td>
</tr>
</tbody>
</table>
<p>其中读未提交和读已提交都好理解。对于可重复读，根据实践操作可以验证，事务A读取的数据，不会受到事务B的修改操作而影响。哪怕事务B已将数据清空或者插入新的数据，在事务A中都不会读取到这些修改。故对于可重复读的事务隔离，是会有幻读的问题。</p>
<h1 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h1><h2 id="读未提交-read-uncommitted"><a href="#读未提交-read-uncommitted" class="headerlink" title="读未提交(read uncommitted)"></a>读未提交(read uncommitted)</h2><table>
<thead>
<tr>
<th>步骤</th>
<th>连接A</th>
<th>连接B</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td><img src="/2018/09/25/transection-isolation/read-uncommitted-a-1.png" alt="包装生成线程安全的hashmap"></td>
<td></td>
</tr>
<tr>
<td></td>
<td>设置隔离级别。更新数据。未提交</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td><img src="/2018/09/25/transection-isolation/read-uncommitted-b-2.png" alt="包装生成线程安全的hashmap"></td>
</tr>
<tr>
<td></td>
<td></td>
<td>设置隔离级别，查询数据，发现可以查询到连接A未提交的数据</td>
</tr>
</tbody>
</table>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>事务隔离：<a href="https://blog.csdn.net/jiyiqinlovexx/article/details/50967965" target="_blank" rel="noopener">https://blog.csdn.net/jiyiqinlovexx/article/details/50967965</a><br>事务：<a href="https://www.cnblogs.com/huanongying/p/7021555.html" target="_blank" rel="noopener">https://www.cnblogs.com/huanongying/p/7021555.html</a><br>事务命令操作：<a href="https://blog.csdn.net/zhu4674548/article/details/75195253" target="_blank" rel="noopener">https://blog.csdn.net/zhu4674548/article/details/75195253</a>  </p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/20/mysql-command/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/20/mysql-command/" itemprop="url">MySql常用操作命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-20T15:19:42+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql数据库/" itemprop="url" rel="index">
                    <span itemprop="name">MySql数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/20/mysql-command/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/20/mysql-command/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="查看mysql服务"><a href="#查看mysql服务" class="headerlink" title="查看mysql服务"></a>查看mysql服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/locl/mysql/support-files/mysql.server start 启动服务</span><br><span class="line">sudo /usr/locl/mysql/support-files/mysql.server stop 停止服务</span><br><span class="line">mysql -V 输出mysql版本</span><br></pre></td></tr></table></figure>
<h1 id="登陆-退出"><a href="#登陆-退出" class="headerlink" title="登陆/退出"></a>登陆/退出</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p 以root用户进行密码登陆</span><br><span class="line">mysql [-h ip]  [-P port] -u user -p 指定ip和端口进行用户登陆，ip和端口条件非必须</span><br><span class="line">exit/quit 退出登陆</span><br></pre></td></tr></table></figure>
<h1 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create user &apos;username&apos;@&apos;host&apos; identified by &apos;password&apos;; 创建用户</span><br><span class="line">drop user &apos;username&apos;@&apos;host&apos;; 删除用户</span><br><span class="line">set password for &apos;username&apos;@&apos;host&apos;= password(&apos;password&apos;); 设置密码</span><br><span class="line">set password = password(&apos;password&apos;);给当前用户设置密码</span><br></pre></td></tr></table></figure>
<p>host需要特别说明：该参数指定了该用户可以登陆的域名，<strong>如果想从任意位置进行登陆使用通配符%。</strong></p>
<p>mysql用户表如图所示：</p>
<p><img src="/2018/09/20/mysql-command/mysql.user.png" alt="包装生成线程安全的hashmap"></p>
<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">grant [select|update|insert|delete|all] on databasename.tablename to &apos;username&apos;@&apos;host&apos;;授权</span><br><span class="line">grant [select|update|insert|delete|all] on databasename.tablename to &apos;username&apos;@&apos;host&apos; with grant option; 给该用户授予的权力，该用户也可以授权给别的用户</span><br><span class="line">show grants for &apos;username&apos;@&apos;host&apos;;查看给用户的授权</span><br><span class="line">revoke [select|update|insert|delete|all] on databasename.tablename from &apos;username&apos;@&apos;host&apos;;撤销授权</span><br></pre></td></tr></table></figure>
<h1 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show databases 查看已有的数据库</span><br><span class="line">use databases dbname 选择采用的数据库</span><br></pre></td></tr></table></figure>
<h1 id="查看表结构"><a href="#查看表结构" class="headerlink" title="查看表结构"></a>查看表结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">desc tablename 查看表结构  </span><br><span class="line">show create table tablename 查看建表语句</span><br></pre></td></tr></table></figure>
<p><img src="/2018/09/20/mysql-command/showtable.png" alt="包装生成线程安全的hashmap"></p>
<h1 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alter table tablename add columnname 数据类型 [primary key/default/not null]；新增列</span><br><span class="line">alter table tablename drop columnname；删除列</span><br><span class="line">alter table tablename change oldcolumnname newcolumnname 数据类型 [primary key/default/not null];修改列名</span><br><span class="line">alter table tablename modify columnname 数据类型 [primary key/default/not null];修改列</span><br><span class="line">alter table tablename rename to newtablename;修改表名</span><br></pre></td></tr></table></figure>
<p><strong>经过测试发现，modify 命令如果后续没有约束，则会清空列已有的约束（不包含主键约束）。如果modify中包含列的约束，则会对列增加约束（包含主键约束）。</strong></p>
<p><img src="/2018/09/20/mysql-command/modifycolumn-1.png" alt="包装生成线程安全的hashmap"><br><img src="/2018/09/20/mysql-command/modifycolumn-2.png" alt="包装生成线程安全的hashmap"></p>
<h1 id="修改约束"><a href="#修改约束" class="headerlink" title="修改约束"></a>修改约束</h1><p>Mysql支持的约束有：  </p>
<ul>
<li>主键约束：primary key。  </li>
<li>外键约束：foreign key。  </li>
<li>唯一：unique.  </li>
<li>非空：not null。</li>
</ul>
<p><strong>可以看到,mysql并不支持check表达式的约束条件，但是在mysql中使用check指令不会报错，但是并没有作用。</strong></p>
<h2 id="主键约束"><a href="#主键约束" class="headerlink" title="主键约束"></a>主键约束</h2><p><img src="/2018/09/20/mysql-command/primary-key.png" alt="包装生成线程安全的hashmap"></p>
<h2 id="唯一约束"><a href="#唯一约束" class="headerlink" title="唯一约束"></a>唯一约束</h2><p><img src="/2018/09/20/mysql-command/unique.png" alt="包装生成线程安全的hashmap"></p>
<p>如图所示，先对列name增加了unique约束，如果想要去除该约束，需要查看约束的名字，一般在定义约束的时候，我们最好还是顺便指定约束的名称，但是在创建的时候没有制定，我们也可以通过查看DDL语句来查看约束的名称，这样我慢看到name字段的unique约束的名称为name，在删除约束的时候还需要注意的是，drop 后面一定要加index，否则会被认为是要删除列。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table tablename add [check_name] (primary key/foreign key/unique/not null) 添加约束，注意最好制定约束名</span><br><span class="line">alter table tablename drop index check_name 通过约束名来去除字段的约束，如果不记得约束名，可以通过show create table tablename来查看DDL语句。</span><br></pre></td></tr></table></figure>
<h1 id="修改索引"><a href="#修改索引" class="headerlink" title="修改索引"></a>修改索引</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table tablename add index indexname (columname,[columnname2...])；新增索引</span><br><span class="line">alter table tablename drop index indexname；删除索引</span><br></pre></td></tr></table></figure>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="查看隔离级别"><a href="#查看隔离级别" class="headerlink" title="查看隔离级别"></a>查看隔离级别</h2><p><img src="/2018/09/20/mysql-command/showtranscationisolation.png" alt="包装生成线程安全的hashmap"></p>
<p>如图所示，通过查看环境变量’isolation’来查看mysql默认的事务隔离级别，可以看到mysql事务的默认隔离级别为<strong>可重复读(REPEATABLE-READ)</strong>。</p>
<h2 id="修改隔离级别"><a href="#修改隔离级别" class="headerlink" title="修改隔离级别"></a>修改隔离级别</h2><p><img src="/2018/09/20/mysql-command/updatetranscation.png" alt="包装生成线程安全的hashmap"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global|session transaction isolation level (read committed|read uncommited|repeatable read|serializable) 设置全局|会话的事务隔离级别。</span><br></pre></td></tr></table></figure>
<h2 id="使用事务"><a href="#使用事务" class="headerlink" title="使用事务"></a>使用事务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start transaction;开启事务</span><br><span class="line">commit;提交事务</span><br><span class="line">rollback;回滚事务</span><br></pre></td></tr></table></figure>
<h1 id="SQL效率"><a href="#SQL效率" class="headerlink" title="SQL效率"></a>SQL效率</h1><h2 id="查看执行时间"><a href="#查看执行时间" class="headerlink" title="查看执行时间"></a>查看执行时间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables； 查看mysql配置参数，主要查找profiling参数是否开启</span><br><span class="line">set profiling = 1； 开启profile配置</span><br><span class="line">show profiles；查看sql指令的耗时</span><br></pre></td></tr></table></figure>
<p><img src="/2018/09/20/mysql-command/showprofiles.png" alt="包装生成线程安全的hashmap"></p>
<h2 id="查看SQL执行效率"><a href="#查看SQL执行效率" class="headerlink" title="查看SQL执行效率"></a>查看SQL执行效率</h2><p>在每次执行sql语句的前面添加explain关键词，就能够输出mysql执行该sql语句的执行效率。</p>
<p><img src="/2018/09/20/mysql-command/explain.png" alt="包装生成线程安全的hashmap"></p>
<h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p>sql执行的标志。</p>
<ul>
<li>如果id相同，则表明这些sql为同一组操作，会按照顺序自上而下的执行。</li>
<li>如果是子查询，id会增加。即id越大执行的优先级越高。</li>
</ul>
<h3 id="select-typea"><a href="#select-typea" class="headerlink" title="select_typea"></a>select_typea</h3><p>查询的类型</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>SIMPLE</td>
<td>简单查询，没有使用UNION或者子查询</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>使用了嵌套查询，则外层查询语句被标记为PRIMARY</td>
</tr>
<tr>
<td>UNION</td>
<td>使用UNION关键词，则UNION后面的SQL语句被标记为UNION</td>
</tr>
<tr>
<td>DEPENDENT UNION</td>
<td>使用UNION关键词，则UNION后面的SQL语句被标记为UNION，取决于外层查询</td>
</tr>
<tr>
<td>UNION RESULT</td>
<td>UNION查询的结果</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>子查询的第一个select</td>
</tr>
<tr>
<td>DEPENDENT SUBQUERY</td>
<td>子查询的第一个select,取决于外层查询</td>
</tr>
<tr>
<td>DERIVED</td>
<td>派生的表（匿名的表）查询的子查询</td>
</tr>
<tr>
<td>UNCACHEABLE SUBQUERY</td>
<td>一个子查询的结果没有被缓存，必须重新评估外链接的第一行</td>
</tr>
</tbody>
</table>
<h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><p>当前语句涉及到的表名，有时不是真实的表名。</p>
<p><img src="/2018/09/20/mysql-command/explain-table.png" alt="包装生成线程安全的hashmap"></p>
<h3 id="partitions"><a href="#partitions" class="headerlink" title="partitions"></a>partitions</h3><p>代表表所使用的分区。目前我不太懂这个有什么用，我的机器输出的结果是null。</p>
<h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p>访问类型，常用的有<strong>ALL, index,  range, ref, eq_ref, const, system, NULL（从左到右，性能从差到好）</strong>。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ALL</td>
<td>全表检索，即mysql遍历所有的行数据才能检索到匹配的数据</td>
</tr>
<tr>
<td>index</td>
<td>全索引检索，即mysql遍历了整个索引树才检索到匹配的数据</td>
</tr>
<tr>
<td>range</td>
<td>在一定范围的行数据中，通过索引来找到匹配的数据</td>
</tr>
<tr>
<td>ref</td>
<td>使用了表连接或者匹配条件中，有使用常量</td>
</tr>
<tr>
<td>eq_ref</td>
<td>在使用表连接的时候，连接的列具有唯一性，即主键或外键</td>
</tr>
<tr>
<td>const</td>
<td>mysql对查询的优化，如果where语句中有主键，则会将整个查询转换成常量</td>
</tr>
<tr>
<td>system</td>
<td>mysql对查询的优化，与const一样，特殊在如果表只有一行数据的时候，采用system</td>
</tr>
<tr>
<td>NULL</td>
<td>mysql在执行sql分解语句时，无需查找表和索引</td>
</tr>
</tbody>
</table>
<h3 id="possible-keys"><a href="#possible-keys" class="headerlink" title="possible_keys"></a>possible_keys</h3><p>查询数据时，能够匹配到数据的索引。</p>
<p><img src="/2018/09/20/mysql-command/explain-type.png" alt="包装生成线程安全的hashmap"></p>
<p>如图所示，接连执行的两条sql语句，可以看到，第二条sql语句中where包含主键的条件，查询的数据可以通过主键索引，也可以通过地址索引，两个索引来检索到第三行数据，故possible_keys中指出了能够检索到这条数据的索引有两个。同时也论证了type列的const的含义，即一旦条件中有主键，mysql就会将该条查询常量化。</p>
<h3 id="key"><a href="#key" class="headerlink" title="key"></a>key</h3><p>查询时，实际使用到的索引。</p>
<h3 id="key-len"><a href="#key-len" class="headerlink" title="key_len"></a>key_len</h3><p>索引字段的最大长度。便于优化索引的长度（索引越短越好）。</p>
<h3 id="rows"><a href="#rows" class="headerlink" title="rows"></a>rows</h3><p>sql语句查询时遍历的行数。</p>
<h3 id="Extra"><a href="#Extra" class="headerlink" title="Extra"></a>Extra</h3><p>额外信息。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Using where</td>
<td>根据where条件来通过索引来检索数据。</td>
</tr>
<tr>
<td>Using temporary</td>
<td>mysql需要使用到临时表空间来进行检索，在分组和排序的时候常见</td>
</tr>
<tr>
<td>Using filesort</td>
<td>mysql无法通过索引来进行的排序，<strong>这种情况需要考虑添加索引了</strong></td>
</tr>
<tr>
<td>Using join buffer</td>
<td>表连接的时候，连接条件没有使用到索引字段，所以需要采用额外的缓冲区来保持结果，<strong>需要在表连接的时候使用索引列，或者添加索引</strong></td>
</tr>
<tr>
<td>Impossible where</td>
<td>where语句可能会有没有符合条件的数据</td>
</tr>
<tr>
<td>Select tables optimized away</td>
<td>仅仅使用索引，优化器可能仅从聚合函数结果中返回一行（<strong>不懂</strong>）</td>
</tr>
</tbody>
</table>
<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><ul>
<li>explain 只能对select 语句进行效率分析。  </li>
<li>explain 不会考虑到缓存。  </li>
<li>explain 的分析结果不会考虑触发器，存储过程以及自定义函数的结果。   </li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="清屏"><a href="#清屏" class="headerlink" title="清屏"></a>清屏</h2><p>Ctrl+L 快捷键清屏</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>查看表结构：<a href="https://www.cnblogs.com/zhangyuhang3/p/6873895.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhangyuhang3/p/6873895.html</a><br>修改表结构：<a href="https://blog.csdn.net/airjordon/article/details/72676607" target="_blank" rel="noopener">https://blog.csdn.net/airjordon/article/details/72676607</a><br>explain详解：<a href="https://www.cnblogs.com/xuanzhi201111/p/4175635.html" target="_blank" rel="noopener">https://www.cnblogs.com/xuanzhi201111/p/4175635.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/19/mysql-engine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小磊砸">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小磊砸的布劳格">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/19/mysql-engine/" itemprop="url">MySql存储引擎</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-19T10:37:03+08:00">
                2018-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySql数据库/" itemprop="url" rel="index">
                    <span itemprop="name">MySql数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/19/mysql-engine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/19/mysql-engine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="相关指令"><a href="#相关指令" class="headerlink" title="相关指令"></a>相关指令</h1><h2 id="查看存储引擎"><a href="#查看存储引擎" class="headerlink" title="查看存储引擎"></a>查看存储引擎</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines 查看当前数据库支持的存储引擎</span><br></pre></td></tr></table></figure>
<p><img src="/2018/09/19/mysql-engine/showengines.png" alt="包装生成线程安全的hashmap"></p>
<p>从结果中可以看到，mysql数据库默认采用的存储引擎是<strong>InnoDB</strong>。</p>
<h2 id="设置存储引擎"><a href="#设置存储引擎" class="headerlink" title="设置存储引擎"></a>设置存储引擎</h2><ul>
<li>可以在创建表的时候通过ENGINE来指定存储引擎。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE country(</span><br><span class="line">    country_id SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">    country VARCHAR(50) NOT NULL,</span><br><span class="line">    last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    PRIMARY KEY (country_id)</span><br><span class="line">) ENGINE = InnoDB DEFAULT CHARSET=gbk;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过修改表结构来设置存储引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALERT TABLE 表名 ENGINE = INNODB;</span><br></pre></td></tr></table></figure>
<h1 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h1><ul>
<li><strong>MySql5.5.8版本以后的默认的存储引擎</strong>。</li>
<li><strong>支持事务，支持行锁。支持外键</strong>。</li>
<li>支持自增（AUTO_INCREMENT）。<strong>支持自增的列必须是数值型的主键。</strong></li>
<li>表结构存储在.frm文件中，数据和索引存储在innodb_data_home和innodb_data_path表空间中。</li>
<li>数据存储采用聚集的方式按照主键的顺序存储。如果在创建表的时候没有指定主键，存储引擎会为每一行数据默认的生成一个6字节长度rowID，并以此作为主键。</li>
<li>InnoDB采用多版本并发控制(MVCC)来控制并发。支持数据库的4种隔离机制。</li>
</ul>
<p><img src="/2018/09/19/mysql-engine/increment.png" alt="包装生成线程安全的hashmap"></p>
<p><img src="/2018/09/19/mysql-engine/desctable.png" alt="包装生成线程安全的hashmap"></p>
<h1 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h1><ul>
<li><strong>Mysql5.5.8版本之前的默认存储引擎</strong>。</li>
<li>MyISAM不支持事务，外键。</li>
<li>MyISAM支持全文检索。</li>
<li>MyISAM存储引擎由frm(存储表结构),MYD(存储数据),MYI（存储索引）三个文件组成。</li>
<li>5.0版本以前默认支持4GB大小存储。通过指定MAX_ROWS和AVG_ROW_LENGTH参数可以支持大于4GB容量。</li>
<li>缓冲池只存储索引文件，数据的缓存交由操作系统负责。</li>
</ul>
<h1 id="MEMORY"><a href="#MEMORY" class="headerlink" title="MEMORY"></a>MEMORY</h1><p>将数据加载在内存中，表结构存储在位于磁盘并与表名同名的frm文件中。<br>存储引擎默认使用哈希索引，在4.1版本前只支持哈希索引，故需要整个键来索引，效率不及MyISAM。4.1版本后支持哈希索引和B树索引。<br>MEMORY表的大小由max_rows和max_heap_table_size决定。max_rows可以在建表时制定。max_heap_table_size默认16M。可以拓展。<strong>如果表的数据量超过设置，mysql会将超出的部分自动按照MyISAM存储引擎来进行存储。</strong>  </p>
<ul>
<li>临时数据。当数据是临时使用同时在其生命周期内存在即可，可以考虑使用MEMORY存储引擎来进行数据存储。</li>
<li>相对无关的数据。数据库宕机数据丢失不会影响业务系统的正常运作。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>mysql貌似各种存储引擎的表结构都是用frm文件进行存储的。</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><blockquote>
<p>存储引擎：<a href="https://www.cnblogs.com/shijiaqi1066/p/3857808.html" target="_blank" rel="noopener">https://www.cnblogs.com/shijiaqi1066/p/3857808.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.jpeg"
                alt="小磊砸" />
            
              <p class="site-author-name" itemprop="name">小磊砸</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小磊砸</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://xiaoleiza.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
